{% extends 'mainpages/base.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
/* ===== TRABAHOLINK THEME VARIABLES ===== */
:root {
  --trabaholink-cyan: #AFE4E6;
  --trabaholink-blue: #5271FF;
  --trabaholink-dark-blue: #004AAD;
  --trabaholink-light-blue: #84C7EE;
  --success-color: #10b981;
  --warning-color: #f59e0b;
  --danger-color: #ef4444;
  --text-dark: #1a202c;
  --text-medium: #4a5568;
  --text-light: #718096;
  --bg-light: #f7fafc;
  --bg-white: #ffffff;
  --border-color: #e2e8f0;
  --gradient-primary: linear-gradient(135deg, var(--trabaholink-blue) 0%, var(--trabaholink-dark-blue) 100%);
  --gradient-accent: linear-gradient(135deg, var(--trabaholink-cyan) 0%, var(--trabaholink-light-blue) 100%);
  --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
}

/* Global Styles */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg-light);
}

/* Page Wrapper */
.service-form-wrapper {
  min-height: 100vh;
  padding: 2rem 0 4rem;
  background: linear-gradient(180deg, #f0f9ff 0%, var(--bg-light) 100%);
}

/* Header Section */
.form-header-section {
  background: var(--gradient-primary);
  color: white;
  padding: 3rem 0;
  margin-bottom: 2.5rem;
  position: relative;
  overflow: hidden;
  border-radius: 0 0 24px 24px;
  box-shadow: var(--shadow-xl);
}

.form-header-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  opacity: 0.3;
}

.form-header-content {
  position: relative;
  z-index: 2;
  text-align: center;
}

.form-header-title {
  font-size: 2.5rem;
  font-weight: 700;
  margin: 0 0 0.75rem 0;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1rem;
}

.form-header-subtitle {
  font-size: 1.125rem;
  opacity: 0.95;
  margin: 0;
}

/* Form Container */
.form-main-container {
  max-width: 1200px;
  margin: 0 auto;
}

.form-card {
  background: white;
  border-radius: 20px;
  box-shadow: var(--shadow-xl);
  overflow: hidden;
  margin-bottom: 2rem;
}

.form-content {
  padding: 3rem;
}

/* Section Styling */
.form-section {
  margin-bottom: 3rem;
  padding: 2rem;
  background: linear-gradient(135deg, #f0f9ff 0%, white 100%);
  border-radius: 16px;
  border: 2px solid var(--trabaholink-cyan);
}

.section-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid var(--trabaholink-blue);
}

.section-icon {
  width: 3rem;
  height: 3rem;
  background: var(--gradient-primary);
  color: white;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  flex-shrink: 0;
  box-shadow: 0 4px 12px rgba(82, 113, 255, 0.3);
}

.section-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-dark);
  margin: 0;
}

/* Form Groups */
.form-group {
  margin-bottom: 1.75rem;
}

.form-label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 600;
  color: var(--text-dark);
  margin-bottom: 0.625rem;
  font-size: 0.95rem;
}

.form-label i {
  color: var(--trabaholink-blue);
  font-size: 1.1rem;
}

.form-label .required {
  color: var(--danger-color);
  margin-left: 0.25rem;
}

.form-control {
  width: 100%;
  padding: 0.875rem 1.125rem;
  border: 2px solid var(--border-color);
  border-radius: 12px;
  font-size: 1rem;
  transition: all 0.3s ease;
  background: var(--bg-white);
  font-family: inherit;
  box-sizing: border-box;
}

.form-control:focus {
  outline: none;
  border-color: var(--trabaholink-blue);
  background: white;
  box-shadow: 0 0 0 4px rgba(82, 113, 255, 0.1);
}

.form-control:hover {
  border-color: var(--trabaholink-light-blue);
}

textarea.form-control {
  min-height: 120px;
  resize: vertical;
}

select.form-control {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%234a5568' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 1rem center;
  padding-right: 2.5rem;
}

/* Form Row */
.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.25rem;
  margin-bottom: 1.75rem;
}

/* Help Text */
.help-text {
  font-size: 0.875rem;
  color: var(--text-light);
  margin-top: 0.5rem;
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
  padding: 0.75rem;
  background: #e0f2fe;
  border-radius: 8px;
  border-left: 3px solid var(--trabaholink-cyan);
}

.help-text i {
  color: var(--trabaholink-blue);
  margin-top: 0.125rem;
  flex-shrink: 0;
}

/* Error Messages */
.error-message, .errorlist {
  color: var(--danger-color);
  font-size: 0.875rem;
  margin-top: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.625rem 0.875rem;
  background: #fee2e2;
  border-radius: 8px;
  border-left: 3px solid var(--danger-color);
  list-style: none;
}

/* Image Upload */
.image-upload-container {
  margin-top: 1rem;
}

.existing-images {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 1.25rem;
  margin-bottom: 1.5rem;
}

.image-item {
  position: relative;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  transition: all 0.3s ease;
}

.image-item:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
}

.image-item img {
  width: 100%;
  height: 150px;
  object-fit: cover;
}

.image-upload-zone {
  border: 3px dashed var(--border-color);
  border-radius: 16px;
  padding: 3rem 2rem;
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;
  background: linear-gradient(135deg, #f0f9ff 0%, white 100%);
}

.image-upload-zone:hover {
  border-color: var(--trabaholink-blue);
  background: linear-gradient(135deg, var(--trabaholink-cyan) 0%, white 100%);
  transform: translateY(-2px);
}

.upload-icon {
  font-size: 3.5rem;
  color: var(--trabaholink-blue);
  margin-bottom: 1rem;
  display: block;
}

.upload-text {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--text-dark);
  margin-bottom: 0.5rem;
}

.upload-hint {
  font-size: 0.875rem;
  color: var(--text-light);
}

/* Map */
.map-container {
  margin-top: 1.5rem;
}

#map {
  height: 400px;
  border-radius: 16px;
  border: 2px solid var(--border-color);
  box-shadow: var(--shadow-md);
  overflow: hidden;
}

.map-info-bar {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
  padding: 1.25rem;
  background: linear-gradient(135deg, var(--trabaholink-cyan) 0%, var(--trabaholink-light-blue) 100%);
  border-radius: 12px;
}

.map-info-item {
  text-align: center;
}

.map-info-label {
  font-size: 0.875rem;
  color: var(--trabaholink-dark-blue);
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.map-info-value {
  font-size: 1.125rem;
  color: var(--text-dark);
  font-weight: 700;
}

/* Action Buttons */
.form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
  padding: 2rem 3rem;
  background: var(--bg-light);
  border-top: 2px solid var(--border-color);
}

.btn {
  padding: 0.875rem 2rem;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.625rem;
  border: none;
  text-decoration: none;
}

.btn-secondary {
  background: white;
  color: var(--text-medium);
  border: 2px solid var(--border-color);
}

.btn-secondary:hover {
  background: var(--bg-light);
  border-color: var(--text-medium);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
  text-decoration: none;
}

.btn-success {
  background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
  color: white;
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
  text-decoration: none;
  color: white;
}

/* Responsive */
@media (max-width: 768px) {
  .form-header-title {
    font-size: 1.75rem;
    flex-direction: column;
  }
  
  .form-content {
    padding: 1.5rem;
  }
  
  .form-section {
    padding: 1.25rem;
  }
  
  .form-actions {
    padding: 1.5rem;
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
    justify-content: center;
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 576px) {
  .service-form-wrapper {
    padding: 1rem 0 2rem;
  }
  
  .form-header-section {
    padding: 2rem 0;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="service-form-wrapper">
  <!-- Header Section -->
  <div class="form-header-section">
    <div class="container">
      <div class="form-header-content">
        <h1 class="form-header-title">
          <i class="bi bi-tools"></i>
          {% if form.instance.pk %}Edit Service Post{% else %}Create Service Post{% endif %}
        </h1>
        <p class="form-header-subtitle">
          {% if form.instance.pk %}Update your service information to attract more clients{% else %}Showcase your skills and connect with clients{% endif %}
        </p>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="form-main-container">
      <form method="post" enctype="multipart/form-data" id="serviceForm">
        {% csrf_token %}
        
        <div class="form-card">
          <div class="form-content">
            {{ form.non_field_errors }}
            
            <!-- Basic Information Section -->
            <div class="form-section">
              <div class="section-header">
                <div class="section-icon">
                  <i class="bi bi-info-circle"></i>
                </div>
                <h3 class="section-title">Basic Information</h3>
              </div>
              
              <div class="form-group">
                <label for="{{ form.headline.id_for_label }}" class="form-label">
                  <i class="bi bi-card-heading"></i>
                  Service Headline
                  {% if form.headline.field.required %}<span class="required">*</span>{% endif %}
                </label>
                {{ form.headline }}
                {{ form.headline.errors }}
                <div class="help-text">
                  <i class="bi bi-lightbulb"></i>
                  <div>
                    <strong>Create an eye-catching headline!</strong><br>
                    Keep it short (50-80 characters) and highlight your main service. 
                    Example: "Professional Web Design & Development Services"
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label for="{{ form.category.id_for_label }}" class="form-label">
                  <i class="bi bi-tag"></i>
                  Category
                  {% if form.category.field.required %}<span class="required">*</span>{% endif %}
                </label>
                {{ form.category }}
                {{ form.category.errors }}
                <div class="help-text">
                  <i class="bi bi-info-circle"></i>
                  <div>
                    Choose the category that best describes your service. This helps customers find you more easily.
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label for="{{ form.description.id_for_label }}" class="form-label">
                  <i class="bi bi-align-left"></i>
                  Service Description
                  {% if form.description.field.required %}<span class="required">*</span>{% endif %}
                </label>
                {{ form.description }}
                {{ form.description.errors }}
                <div class="help-text">
                  <i class="bi bi-edit"></i>
                  <div>
                    <strong>Describe your service in detail:</strong><br>
                    • What services do you offer?<br>
                    • What makes you different from competitors?<br>
                    • What can customers expect?<br>
                    • Include your experience and qualifications
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label for="{{ form.availability.id_for_label }}" class="form-label">
                  <i class="bi bi-clock"></i>
                  Availability
                  {% if form.availability.field.required %}<span class="required">*</span>{% endif %}
                </label>
                {{ form.availability }}
                {{ form.availability.errors }}
                <div class="help-text">
                  <i class="bi bi-calendar"></i>
                  <div>
                    Let customers know when you're available. Example: "Monday-Friday 9AM-6PM" or "Weekends only"
                  </div>
                </div>
              </div>
            </div>

            <!-- Contact Information Section -->
            <div class="form-section">
              <div class="section-header">
                <div class="section-icon">
                  <i class="bi bi-telephone"></i>
                </div>
                <h3 class="section-title">Contact Information</h3>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label for="{{ form.contact_number.id_for_label }}" class="form-label">
                    <i class="bi bi-phone"></i>
                    Contact Number
                    {% if form.contact_number.field.required %}<span class="required">*</span>{% endif %}
                  </label>
                  {{ form.contact_number }}
                  {{ form.contact_number.errors }}
                  <div class="help-text">
                    <i class="bi bi-phone"></i>
                    <div>
                      Provide a valid phone number where customers can reach you. Include area code.
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="{{ form.email.id_for_label }}" class="form-label">
                    <i class="bi bi-envelope"></i>
                    Email Address
                    {% if form.email.field.required %}<span class="required">*</span>{% endif %}
                  </label>
                  {{ form.email }}
                  {{ form.email.errors }}
                  <div class="help-text">
                    <i class="bi bi-envelope"></i>
                    <div>
                      Professional email address for business inquiries. This will be visible to potential customers.
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label for="{{ form.address.id_for_label }}" class="form-label">
                  <i class="bi bi-map"></i>
                  Address
                  {% if form.address.field.required %}<span class="required">*</span>{% endif %}
                </label>
                {{ form.address }}
                {{ form.address.errors }}
                <div class="help-text">
                  <i class="bi bi-geo-alt"></i>
                  <div>
                    General service area or business address
                  </div>
                </div>
              </div>
            </div>

            <!-- Location Section -->
            <div class="form-section">
              <div class="section-header">
                <div class="section-icon">
                  <i class="bi bi-geo-alt"></i>
                </div>
                <h3 class="section-title">Service Location</h3>
              </div>
              
              <div class="map-container">
                <label class="form-label">
                  <i class="bi bi-pin-map"></i>
                  Pin Your Service Location
                  <span class="required">*</span>
                </label>
                <div class="help-text" style="margin-bottom: 1rem;">
                  <i class="bi bi-map"></i>
                  <div>
                    <strong>Pin your service location on the map:</strong><br>
                    • Click on the map or drag the marker to set your location<br>
                    • This helps customers find services near them<br>
                    • Your exact address won't be shown publicly
                  </div>
                </div>
                <div id="map"></div>
                <input type="hidden" name="latitude" id="latitude" value="{{ form.instance.location.y|default:'14.4310956' }}">
                <input type="hidden" name="longitude" id="longitude" value="{{ form.instance.location.x|default:'120.968096097231' }}">
                
                <div class="map-info-bar">
                  <div class="map-info-item">
                    <div class="map-info-label">Latitude</div>
                    <div class="map-info-value" id="lat-display">{{ form.instance.location.y|default:'Not set' }}</div>
                  </div>
                  <div class="map-info-item">
                    <div class="map-info-label">Longitude</div>
                    <div class="map-info-value" id="lon-display">{{ form.instance.location.x|default:'Not set' }}</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Images Section -->
            <div class="form-section">
              <div class="section-header">
                <div class="section-icon">
                  <i class="bi bi-images"></i>
                </div>
                <h3 class="section-title">Service Images</h3>
              </div>
              
              {% if form.instance.pk and form.instance.images.all %}
                <div class="form-group">
                  <label class="form-label">
                    <i class="bi bi-image"></i>
                    Existing Images
                  </label>
                  <div class="existing-images">
                    {% for image in form.instance.images.all %}
                      <div class="image-item">
                        <img src="{{ image.image.url }}" alt="Service Image">
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
              
              <div class="image-upload-container">
                <label class="form-label">
                  <i class="bi bi-cloud-upload"></i>
                  {% if form.instance.pk %}Upload Additional Images{% else %}Upload Images{% endif %}
                </label>
                <div class="help-text" style="margin-bottom: 1rem;">
                  <i class="bi bi-camera"></i>
                  <div>
                    <strong>Upload high-quality images that showcase your work:</strong><br>
                    • Before/after photos<br>
                    • Examples of completed projects<br>
                    • Your workspace or tools<br>
                    • Professional headshot (recommended for first image)
                  </div>
                </div>
                <label for="id_images" class="image-upload-zone">
                  <input type="file" name="images" id="id_images" multiple class="form-control" style="display: none;">
                  <i class="bi bi-cloud-arrow-up upload-icon"></i>
                  <div class="upload-text">Click to upload or drag and drop</div>
                  <div class="upload-hint">PNG, JPG, JPEG up to 5MB each • Multiple files supported</div>
                </label>
                <div id="image-previews" class="existing-images" style="margin-top: 1.5rem;"></div>
              </div>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <a href="{% url 'jobs:job_list' %}" class="btn btn-secondary">
              <i class="bi bi-x-circle"></i>
              Cancel
            </a>
            <button type="submit" class="btn btn-success">
              <i class="bi bi-check-circle"></i>
              {% if form.instance.pk %}Update Service{% else %}Create Service{% endif %}
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function(){
  // Apply form control classes
  const formControls = document.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], select, textarea');
  formControls.forEach(control => {
    if (!control.classList.contains('form-control')) {
      control.classList.add('form-control');
    }
  });

  // Get hidden input values or set default coordinates
  const latInput = document.getElementById('latitude');
  const lngInput = document.getElementById('longitude');
  let lat = parseFloat(latInput.value) || 14.4310956;
  let lng = parseFloat(lngInput.value) || 120.968096097231;
  
  // Initialize the map and marker
  var map = L.map('map').setView([lat, lng], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  var marker = L.marker([lat, lng], { draggable: true }).addTo(map);
  
  function updateCoordinates(lat, lng) {
    latInput.value = lat;
    lngInput.value = lng;
    document.getElementById('lat-display').textContent = lat.toFixed(6);
    document.getElementById('lon-display').textContent = lng.toFixed(6);
  }
  
  // Update hidden fields when marker is dragged
  marker.on('dragend', function(e){
    var pos = e.target.getLatLng();
    updateCoordinates(pos.lat, pos.lng);
  });
  
  // Also update marker and hidden fields on map click
  map.on('click', function(e){
    marker.setLatLng(e.latlng);
    updateCoordinates(e.latlng.lat, e.latlng.lng);
  });
  
  // Initialize display
  updateCoordinates(lat, lng);

  // File upload visual feedback
  const fileInput = document.getElementById('id_images');
  const uploadArea = document.querySelector('.image-upload-zone');
  const previewContainer = document.getElementById('image-previews');
  
  fileInput.addEventListener('change', function(e) {
    previewContainer.innerHTML = '';
    const files = e.target.files;
    
    if (files.length > 0) {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();
        reader.onload = function(e) {
          const div = document.createElement('div');
          div.className = 'image-item';
          div.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
          previewContainer.appendChild(div);
        }
        reader.readAsDataURL(file);
      }
      
      uploadArea.innerHTML = `
        <i class="bi bi-check-circle upload-icon" style="color: var(--success-color);"></i>
        <div class="upload-text" style="color: var(--success-color);">${files.length} file(s) selected</div>
        <div class="upload-hint">Click to change files</div>
      `;
    }
  });

  // Drag and drop functionality
  uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.style.borderColor = 'var(--trabaholink-blue)';
    this.style.backgroundColor = 'var(--trabaholink-cyan)';
  });

  uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.style.borderColor = '';
    this.style.backgroundColor = '';
  });

  uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    this.style.borderColor = '';
    this.style.backgroundColor = '';
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      fileInput.files = files;
      fileInput.dispatchEvent(new Event('change'));
    }
  });
  
  // Fix map display
  setTimeout(() => { map.invalidateSize(); }, 100);
});
</script>
{% endblock %}
