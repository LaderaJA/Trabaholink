{% extends 'mainpages/base.html' %}
{% load static %}

{% block title %}Services - Trabaholink{% endblock %}

{% block content %}
<style>
:root {
  --primary-blue: #3b82f6;
  --primary-blue-dark: #2563eb;
  --primary-blue-light: #dbeafe;
  --text-dark: #111827;
  --text-medium: #374151;
  --text-light: #6b7280;
  --background-white: #ffffff;
  --background-gray: #f9fafb;
  --border-color: #e5e7eb;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.services-header {
  background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
  color: white;
  padding: 3rem 0;
  margin-bottom: 2rem;
  border-radius: 0 0 2rem 2rem;
  box-shadow: var(--shadow-lg);
}

.services-header h1 {
  font-size: 2.5rem;
  font-weight: 700;
  margin: 0 0 0.5rem 0;
}

.services-header p {
  font-size: 1.125rem;
  opacity: 0.9;
  margin: 0;
}

.service-card {
  background: var(--background-white);
  border-radius: 1rem;
  overflow: hidden;
  box-shadow: var(--shadow-md);
  transition: all 0.3s ease;
  height: 100%;
  display: flex;
  flex-direction: column;
}

.service-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-lg);
}

.service-image {
  width: 100%;
  height: 200px;
  object-fit: cover;
  background: linear-gradient(135deg, var(--primary-blue-light) 0%, #bfdbfe 100%);
}

.service-image-placeholder {
  width: 100%;
  height: 200px;
  background: linear-gradient(135deg, var(--primary-blue-light) 0%, #bfdbfe 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--primary-blue);
  font-size: 3rem;
}

.service-content {
  padding: 1.5rem;
  flex: 1;
  display: flex;
  flex-direction: column;
}

.service-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--text-dark);
  margin: 0 0 0.5rem 0;
  line-height: 1.4;
}

.service-title a {
  color: var(--text-dark);
  text-decoration: none;
  transition: color 0.2s;
}

.service-title a:hover {
  color: var(--primary-blue);
}

.service-description {
  color: var(--text-medium);
  font-size: 0.875rem;
  line-height: 1.6;
  margin-bottom: 1rem;
  flex: 1;
}

.service-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  font-size: 0.875rem;
  color: var(--text-light);
  margin-bottom: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
}

.service-meta-item {
  display: flex;
  align-items: center;
  gap: 0.375rem;
}

.service-price {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--primary-blue);
  margin-bottom: 1rem;
}

.btn-view {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  background: var(--primary-blue);
  color: white;
  border-radius: 0.5rem;
  text-decoration: none;
  font-weight: 500;
  transition: all 0.2s;
  width: 100%;
}

.btn-view:hover {
  background: var(--primary-blue-dark);
  color: white;
  text-decoration: none;
  transform: translateY(-1px);
}

.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  background: var(--background-white);
  border-radius: 1rem;
  box-shadow: var(--shadow-md);
}

.empty-state i {
  font-size: 4rem;
  color: var(--text-light);
  margin-bottom: 1rem;
}

.empty-state h3 {
  font-size: 1.5rem;
  color: var(--text-dark);
  margin-bottom: 0.5rem;
}

.empty-state p {
  color: var(--text-medium);
  margin-bottom: 1.5rem;
}

@media (max-width: 768px) {
  .services-header h1 {
    font-size: 2rem;
  }
  
  .service-image,
  .service-image-placeholder {
    height: 150px;
  }
}
</style>

<!-- Services Header -->
<div class="services-header">
  <div class="container">
    <h1>Available Services</h1>
    <p>Find skilled professionals for your needs</p>
  </div>
</div>

<div class="container">
  {% if posts %}
  <div class="row g-4 mb-5">
    {% for service in posts %}
    <div class="col-md-6 col-lg-4">
      <div class="service-card" data-lat="{{ service.location.y }}" data-lng="{{ service.location.x }}">
        {% if service.images.first %}
          <img src="{{ service.images.first.image.url }}" alt="{{ service.headline }}" class="service-image">
        {% else %}
          <div class="service-image-placeholder">
            <i class="fa fa-wrench"></i>
          </div>
        {% endif %}
        
        <div class="service-content">
          <h3 class="service-title">
            <a href="{% url 'services:servicepost_detail' service.slug %}">{{ service.headline }}</a>
          </h3>
          
          <p class="service-description">{{ service.description|truncatewords:20 }}</p>
          
          {% if service.pricing %}
          <div class="service-price">â‚±{{ service.pricing }}</div>
          {% endif %}
          
          <div class="service-meta">
            <div class="service-meta-item">
              <i class="fa fa-user"></i>
              <span>{{ service.worker.username }}</span>
            </div>
            <div class="service-meta-item">
              <i class="fa fa-tag"></i>
              <span>{{ service.category.name|default:"Service" }}</span>
            </div>
            <div class="service-meta-item">
              <i class="fa fa-calendar"></i>
              <span>{{ service.created_at|date:"M d, Y" }}</span>
            </div>
            <div class="service-meta-item distance-display" style="display: none; color: var(--primary-blue); font-weight: 600;">
              <i class="fa fa-map-marker-alt"></i>
              <span>Calculating...</span>
            </div>
          </div>
          
          <a href="{% url 'services:servicepost_detail' service.slug %}" class="btn-view">
            <i class="fa fa-eye"></i>
            View Service
          </a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  
  <!-- Pagination -->
  {% if is_paginated %}
  <nav aria-label="Page navigation" class="mb-5">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page=1">First</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
      </li>
      {% endif %}
      
      <li class="page-item active">
        <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
      </li>
      
      {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last</a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
  
  {% else %}
  <div class="empty-state">
    <i class="fa fa-wrench"></i>
    <h3>No Services Available</h3>
    <p>There are currently no services listed. Check back later!</p>
  </div>
  {% endif %}
</div>

<script>
// LocationManager - Auto-detect and display distances
const LocationManager = {
    CACHE_KEY: 'trabaholink_user_location',
    CACHE_DURATION: 24 * 60 * 60 * 1000, // 24 hours
    
    getCachedLocation() {
        const cached = localStorage.getItem(this.CACHE_KEY);
        if (!cached) return null;
        
        try {
            const location = JSON.parse(cached);
            if (Date.now() - location.timestamp > this.CACHE_DURATION) {
                localStorage.removeItem(this.CACHE_KEY);
                return null;
            }
            return location;
        } catch (e) {
            return null;
        }
    },
    
    async getCurrentLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('Geolocation not supported'));
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const location = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(this.CACHE_KEY, JSON.stringify(location));
                    resolve(location);
                },
                (error) => {
                    console.log('Location error:', error.message);
                    reject(error);
                },
                { 
                    enableHighAccuracy: false,
                    timeout: 10000,
                    maximumAge: 300000 // 5 minutes
                }
            );
        });
    },
    
    calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },
    
    formatDistance(km) {
        if (km < 1) {
            return Math.round(km * 1000) + 'm away';
        } else if (km < 10) {
            return km.toFixed(1) + 'km away';
        } else {
            return Math.round(km) + 'km away';
        }
    },
    
    async initializeDistances() {
        try {
            // Try to get cached location first
            let location = this.getCachedLocation();
            
            // If no cache, get current location
            if (!location) {
                console.log('Getting current location...');
                location = await this.getCurrentLocation();
            }
            
            if (location) {
                console.log('User location:', location);
                this.updateDistances(location);
            }
        } catch (error) {
            console.log('Could not get location:', error.message);
            // Hide all distance displays if location unavailable
            document.querySelectorAll('.distance-display').forEach(el => {
                el.style.display = 'none';
            });
        }
    },
    
    updateDistances(userLocation) {
        const serviceCards = document.querySelectorAll('[data-lat][data-lng]');
        
        serviceCards.forEach(card => {
            const serviceLat = parseFloat(card.dataset.lat);
            const serviceLng = parseFloat(card.dataset.lng);
            
            if (!isNaN(serviceLat) && !isNaN(serviceLng)) {
                const distance = this.calculateDistance(
                    userLocation.latitude,
                    userLocation.longitude,
                    serviceLat,
                    serviceLng
                );
                
                const distanceDisplay = card.querySelector('.distance-display');
                if (distanceDisplay) {
                    const span = distanceDisplay.querySelector('span');
                    if (span) {
                        span.textContent = this.formatDistance(distance);
                    }
                    distanceDisplay.style.display = 'flex';
                }
            }
        });
    }
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    LocationManager.initializeDistances();
});
</script>
{% endblock %}
