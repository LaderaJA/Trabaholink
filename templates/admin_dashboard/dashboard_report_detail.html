{% extends 'admin_dashboard/dashboard_base.html' %}

{% block title %}Report Details #{{ report.pk }}{% endblock %}
{% block page_title %}Report Details{% endblock %}

{% block breadcrumb_items %}
<li><i data-lucide="chevron-right" class="w-4 h-4 inline"></i></li>
<li><a href="{% url 'admin_dashboard:report_list' %}" class="hover:text-trabaholink-blue">Reports</a></li>
<li><i data-lucide="chevron-right" class="w-4 h-4 inline"></i></li>
<li class="text-gray-800">Report #{{ report.pk }}</li>
{% endblock %}

{% block content %}
<!-- Report Header -->
<div class="bg-white rounded-xl shadow-md p-6 mb-6">
    <div class="flex items-start justify-between">
        <div class="flex-1">
            <div class="flex items-center gap-3 mb-3">
                <h1 class="text-2xl font-bold text-gray-900">{{ report.report_type }} Report</h1>
                <span id="statusBadge" class="px-3 py-1 text-sm font-semibold rounded-full
                    {% if report.status == 'pending' %}bg-yellow-100 text-yellow-800
                    {% elif report.status == 'reviewed' %}bg-blue-100 text-blue-800
                    {% else %}bg-green-100 text-green-800{% endif %}">
                    {{ report.get_status_display }}
                </span>
            </div>
            
            <div class="flex items-center gap-6 text-gray-600 text-sm">
                <div class="flex items-center gap-2">
                    <i data-lucide="user" class="w-4 h-4"></i>
                    {% if report.reporter %}
                        <span>Reported by <a href="{% url 'admin_dashboard:user_detail' report.reporter.pk %}" class="text-trabaholink-blue hover:underline font-medium">{{ report.reporter.username }}</a></span>
                    {% else %}
                        <span>Reported by <span class="font-medium">Anonymous</span></span>
                    {% endif %}
                </div>
                <div class="flex items-center gap-2">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span>{{ report.created_at|date:"F d, Y g:i A" }}</span>
                </div>
                <div class="flex items-center gap-2">
                    <i data-lucide="clock" class="w-4 h-4"></i>
                    <span>{{ report.created_at|timesince }} ago</span>
                </div>
            </div>
        </div>
        
        <!-- Quick Status Update -->
        <div class="flex items-center gap-2">
            <select id="quickStatusUpdate" onchange="quickUpdateStatus()" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-trabaholink-blue">
                <option value="">Change Status...</option>
                <option value="pending" {% if report.status == 'pending' %}selected{% endif %}>Pending</option>
                <option value="reviewed" {% if report.status == 'reviewed' %}selected{% endif %}>Reviewed</option>
                <option value="resolved" {% if report.status == 'resolved' %}selected{% endif %}>Resolved</option>
            </select>
        </div>
    </div>
</div>

<!-- Report Content Grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Report Details -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="file-text" class="w-5 h-5 text-trabaholink-blue"></i>
                Report Content
            </h3>
            <div class="prose max-w-none">
                <p class="text-gray-700 whitespace-pre-wrap">{{ report.reason }}</p>
            </div>
        </div>
        
        <!-- Evidence/Screenshot -->
        {% if report.screenshot %}
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="image" class="w-5 h-5 text-trabaholink-blue"></i>
                Evidence
            </h3>
            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <img src="{{ report.screenshot.url }}" alt="Evidence" class="w-full h-auto cursor-pointer hover:opacity-90 transition" onclick="openImageModal('{{ report.screenshot.url }}')">
            </div>
            <a href="{{ report.screenshot.url }}" download class="mt-3 inline-flex items-center gap-2 text-trabaholink-blue hover:text-trabaholink-dark-blue text-sm">
                <i data-lucide="download" class="w-4 h-4"></i>
                Download Evidence
            </a>
        </div>
        {% endif %}
        
        <!-- Reported User/Content -->
        {% if report.reported_user %}
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="user-x" class="w-5 h-5 text-red-500"></i>
                Reported User
            </h3>
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-trabaholink-blue rounded-full flex items-center justify-center text-white font-bold text-lg">
                        {{ report.reported_user.username.0|upper }}
                    </div>
                    <div>
                        <p class="font-medium text-gray-800">{{ report.reported_user.get_full_name|default:report.reported_user.username }}</p>
                        <p class="text-sm text-gray-500">@{{ report.reported_user.username }}</p>
                    </div>
                </div>
                <a href="{% url 'admin_dashboard:user_detail' report.reported_user.pk %}" class="px-4 py-2 bg-trabaholink-blue text-white rounded-lg hover:bg-trabaholink-dark-blue transition text-sm">
                    View Profile
                </a>
            </div>
        </div>
        {% endif %}
        
        {% if report.reported_post %}
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="briefcase" class="w-5 h-5 text-trabaholink-blue"></i>
                Reported Job Post
            </h3>
            <div class="border border-gray-200 rounded-lg p-4">
                <h4 class="font-semibold text-gray-800 mb-2">{{ report.reported_post.title }}</h4>
                <p class="text-sm text-gray-600 mb-3">{{ report.reported_post.description|truncatewords:30 }}</p>
                <a href="{% url 'admin_dashboard:job_detail' report.reported_post.pk %}" class="inline-flex items-center gap-2 text-trabaholink-blue hover:text-trabaholink-dark-blue text-sm">
                    View Job Details <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </a>
            </div>
        </div>
        {% endif %}
        
        <!-- Admin Notes -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="sticky-note" class="w-5 h-5 text-trabaholink-blue"></i>
                Admin Notes
            </h3>
            <textarea id="adminNotes" rows="4" placeholder="Add internal notes about this report..." 
                      class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-trabaholink-blue mb-3">{{ report.admin_notes|default:"" }}</textarea>
            <button onclick="saveAdminNotes()" class="px-4 py-2 bg-trabaholink-blue text-white rounded-lg hover:bg-trabaholink-dark-blue transition">
                Save Notes
            </button>
        </div>
    </div>
    
    <!-- Sidebar - Actions -->
    <div class="space-y-6">
        <!-- Report Information -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="info" class="w-5 h-5 text-trabaholink-blue"></i>
                Report Information
            </h3>
            <div class="space-y-3">
                <div>
                    <p class="text-sm text-gray-500">Report ID</p>
                    <p class="text-gray-800 font-medium">#{{ report.pk }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Type</p>
                    <p class="text-gray-800 font-medium">{{ report.get_report_type_display }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Status</p>
                    <p class="text-gray-800 font-medium">{{ report.get_status_display }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Submitted</p>
                    <p class="text-gray-800 font-medium">{{ report.created_at|date:"M d, Y" }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Last Updated</p>
                    {% if report.reviewed_at %}
                        <p class="text-gray-800 font-medium">{{ report.reviewed_at|date:"M d, Y g:i A" }}</p>
                    {% else %}
                        <p class="text-gray-800 font-medium">Pending Review</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Primary Actions -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="zap" class="w-5 h-5 text-trabaholink-blue"></i>
                Actions
            </h3>
            <div class="space-y-2">
                <!-- Mark as Reviewed -->
                <button onclick="updateReportStatus('reviewed')" 
                        class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition flex items-center justify-center gap-2"
                        {% if report.status == 'reviewed' %}disabled{% endif %}>
                    <i data-lucide="eye" class="w-4 h-4"></i>
                    Mark as Reviewed
                </button>
                
                <!-- Mark as Resolved -->
                <button onclick="updateReportStatus('resolved')" 
                        class="w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition flex items-center justify-center gap-2"
                        {% if report.status == 'resolved' %}disabled{% endif %}>
                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                    Mark as Resolved
                </button>
                
                <!-- Dismiss Report -->
                <button onclick="dismissReport()" 
                        class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition flex items-center justify-center gap-2">
                    <i data-lucide="x-circle" class="w-4 h-4"></i>
                    Dismiss Report
                </button>
            </div>
        </div>
        
        <!-- User Actions (if reported user exists) -->
        {% if report.reported_user %}
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="shield-alert" class="w-5 h-5 text-red-500"></i>
                User Actions
            </h3>
            <div class="space-y-2">
                <!-- Send Warning -->
                <button onclick="openWarningModal()" 
                        class="w-full px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition flex items-center justify-center gap-2">
                    <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                    Send Warning
                </button>
                
                <!-- Suspend User -->
                <button onclick="suspendUser({{ report.reported_user.pk }})" 
                        class="w-full px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition flex items-center justify-center gap-2">
                    <i data-lucide="user-x" class="w-4 h-4"></i>
                    Suspend User
                </button>
                
                <!-- Ban User -->
                <button onclick="banUser({{ report.reported_user.pk }})" 
                        class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition flex items-center justify-center gap-2">
                    <i data-lucide="ban" class="w-4 h-4"></i>
                    Ban User
                </button>
            </div>
        </div>
        {% endif %}
        
        <!-- Content Actions (if job posting exists) -->
        {% if report.reported_post %}
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="briefcase" class="w-5 h-5 text-orange-500"></i>
                Job Actions
            </h3>
            <div class="space-y-2">
                <!-- Deactivate Job -->
                <button onclick="deactivateJob({{ report.reported_post.pk }})" 
                        class="w-full px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition flex items-center justify-center gap-2">
                    <i data-lucide="x-octagon" class="w-4 h-4"></i>
                    Deactivate Job
                </button>
                
                <!-- Delete Job -->
                <button onclick="deleteJob({{ report.reported_post.pk }})" 
                        class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition flex items-center justify-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                    Delete Job
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Warning Modal -->
<div id="warningModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-500"></i>
                    Send Warning
                </h3>
                <button onclick="closeWarningModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
        <div class="p-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Warning Message</label>
            <textarea id="warningMessage" rows="4" 
                      class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" 
                      placeholder="Enter warning message for the user..."></textarea>
        </div>
        <div class="p-6 border-t border-gray-200 flex gap-3 justify-end">
            <button onclick="closeWarningModal()" 
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                Cancel
            </button>
            <button onclick="sendWarning()" 
                    class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition">
                Send Warning
            </button>
        </div>
    </div>
</div>

<script>
const reportId = {{ report.pk }};
{% if report.reported_user %}
const reportedUserId = {{ report.reported_user.pk }};
const reportedUsername = '{{ report.reported_user.username }}';
{% endif %}
{% if report.reported_post %}
const reportedJobId = {{ report.reported_post.pk }};
const reportedJobTitle = '{{ report.reported_post.title|escapejs }}';
{% endif %}

// Warning Modal Functions
function openWarningModal() {
    document.getElementById('warningModal').classList.remove('hidden');
}

function closeWarningModal() {
    document.getElementById('warningModal').classList.add('hidden');
    document.getElementById('warningMessage').value = '';
}

function sendWarning() {
    const message = document.getElementById('warningMessage').value.trim();
    if (!message) {
        alert('Please enter a warning message');
        return;
    }
    
    if (!confirm(`Send warning to ${reportedUsername}?`)) return;
    
    fetch(`/admin_dashboard/users/${reportedUserId}/warn/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Warning sent successfully');
            closeWarningModal();
        } else {
            alert('Error: ' + (data.message || 'Failed to send warning'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while sending the warning');
    });
}

// User Action Functions
function suspendUser(userId) {
    if (!confirm(`Suspend user ${reportedUsername}? This will deactivate their account.`)) return;
    
    fetch(`/admin_dashboard/users/${userId}/toggle/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ action: 'suspend' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('User suspended successfully');
            location.reload();
        } else {
            alert('Error: ' + (data.message || 'Failed to suspend user'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}

function banUser(userId) {
    if (!confirm(`Ban user ${reportedUsername}? This is a permanent action.`)) return;
    
    fetch(`/admin_dashboard/users/${userId}/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('User banned successfully');
            window.location.href = '{% url "admin_dashboard:report_list" %}';
        } else {
            alert('Error: ' + (data.message || 'Failed to ban user'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}

// Job Action Functions
function deactivateJob(jobId) {
    if (!confirm(`Deactivate job "${reportedJobTitle}"?`)) return;
    
    fetch(`/admin_dashboard/jobs/${jobId}/toggle/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Job deactivated successfully');
            location.reload();
        } else {
            alert('Error: ' + (data.message || 'Failed to deactivate job'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}

function deleteJob(jobId) {
    if (!confirm(`Delete job "${reportedJobTitle}"? This action cannot be undone.`)) return;
    
    fetch(`/admin_dashboard/jobs/${jobId}/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Job deleted successfully');
            window.location.href = '{% url "admin_dashboard:report_list" %}';
        } else {
            alert('Error: ' + (data.message || 'Failed to delete job'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}

// Report Status Functions
function updateReportStatus(status) {
    fetch('{% url "admin_dashboard:update_report_status" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            report_id: reportId,
            status: status
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Report status updated successfully');
            location.reload();
        } else {
            alert('Error: ' + (data.message || 'Failed to update status'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}

function dismissReport() {
    if (!confirm('Dismiss this report?')) return;
    updateReportStatus('dismissed');
}

function saveAdminNotes() {
    const notes = document.getElementById('adminNotes').value;
    
    fetch(`/admin_dashboard/reports/${reportId}/notes/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ notes: notes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Notes saved successfully');
        } else {
            alert('Error: ' + (data.message || 'Failed to save notes'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}
</script>

{% endblock %}
          