{% extends 'mainpages/base.html' %}
{% load static %}

{% block content %}
<style>
:root {
  --primary-color: #1a94d4;
  --primary-dark: #0d6efd;
  --primary-light: #e6f4ff;
  --success-color: #10b981;
  --warning-color: #f59e0b;
  --danger-color: #ef4444;
  --text-dark: #2d3748;
  --text-medium: #4a5568;
  --text-light: #718096;
  --bg-light: #f7fafc;
  --bg-white: #ffffff;
  --border-color: #e2e8f0;
  --gradient-primary: linear-gradient(135deg, #1a94d4 0%, #0d6efd 100%);
  --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

/* Compact Hero Section */
.compact-hero {
  background: var(--gradient-primary);
  padding: 2rem 0 1.5rem;
  position: relative;
  overflow: hidden;
}

.compact-hero::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  opacity: 0.3;
}

.compact-hero .container {
  position: relative;
  z-index: 2;
}

.hero-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.hero-title-section h1 {
  color: white;
  font-size: 1.75rem;
  font-weight: 700;
  margin: 0 0 0.25rem 0;
}

.hero-title-section p {
  color: rgba(255, 255, 255, 0.9);
  margin: 0;
  font-size: 0.95rem;
}

.hero-stats {
  display: flex;
  gap: 2rem;
}

.stat-item {
  text-align: center;
  color: white;
}

.stat-number {
  font-size: 1.5rem;
  font-weight: 700;
  display: block;
}

.stat-label {
  font-size: 0.85rem;
  opacity: 0.9;
}

/* Minimized Search Bar */
.search-bar-compact {
  background: white;
  border-radius: 12px;
  padding: 0.75rem 1rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  box-shadow: var(--shadow-lg);
}

.search-input-compact {
  flex: 1;
  border: none;
  outline: none;
  font-size: 0.95rem;
  padding: 0.5rem;
}

.search-input-compact::placeholder {
  color: var(--text-light);
}

.filter-toggle-btn {
  background: var(--bg-light);
  border: 1px solid var(--border-color);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  color: var(--text-dark);
  font-weight: 500;
}

.filter-toggle-btn:hover {
  background: var(--primary-light);
  border-color: var(--primary-color);
  color: var(--primary-color);
}

.filter-toggle-btn.active {
  background: var(--primary-color);
  border-color: var(--primary-color);
  color: white;
}

.search-btn-compact {
  background: var(--gradient-primary);
  color: white;
  border: none;
  padding: 0.5rem 1.5rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.search-btn-compact:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

/* Collapsible Filters */
.filters-panel {
  background: white;
  border-radius: 12px;
  margin-top: 1rem;
  padding: 1.5rem;
  box-shadow: var(--shadow-md);
  display: none;
  animation: slideDown 0.3s ease-out;
}

.filters-panel.show {
  display: block;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.filter-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 1rem;
}

.filter-group label {
  display: block;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-dark);
  margin-bottom: 0.5rem;
}

.filter-group select,
.filter-group input {
  width: 100%;
  padding: 0.6rem;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  font-size: 0.9rem;
  transition: all 0.2s;
}

.filter-group select:focus,
.filter-group input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(26, 148, 212, 0.1);
}

.filter-actions {
  display: flex;
  gap: 0.75rem;
  justify-content: flex-end;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
}

/* Main Content */
.main-wrapper {
  background: var(--bg-light);
  min-height: 70vh;
  padding: 2rem 0;
}

.content-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.results-info {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.results-count {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text-dark);
}

.results-count span {
  color: var(--primary-color);
}

.view-toggle {
  display: flex;
  gap: 0.5rem;
  background: white;
  padding: 0.25rem;
  border-radius: 8px;
  border: 1px solid var(--border-color);
}

.view-btn {
  padding: 0.5rem 0.75rem;
  border: none;
  background: none;
  cursor: pointer;
  border-radius: 6px;
  color: var(--text-medium);
  transition: all 0.2s;
}

.view-btn.active {
  background: var(--primary-color);
  color: white;
}

.content-actions {
  display: flex;
  gap: 0.75rem;
  align-items: center;
  flex-wrap: wrap;
}

.sort-dropdown {
  padding: 0.6rem 1rem;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  background: white;
  font-size: 0.9rem;
  cursor: pointer;
  min-width: 180px;
}

.btn-primary-custom {
  background: var(--gradient-primary);
  color: white;
  padding: 0.6rem 1.25rem;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.2s;
  border: none;
  cursor: pointer;
  font-size: 0.9rem;
}

.btn-primary-custom:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
  color: white;
  text-decoration: none;
}

/* Job Cards - List View */
.jobs-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.job-card-list {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  transition: all 0.3s;
  display: flex;
  gap: 1.5rem;
  position: relative;
}

.job-card-list:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.job-thumbnail {
  width: 180px;
  height: 140px;
  border-radius: 10px;
  overflow: hidden;
  flex-shrink: 0;
  background: var(--bg-light);
  position: relative;
}

.job-thumbnail img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s;
}

.job-card-list:hover .job-thumbnail img {
  transform: scale(1.05);
}

.no-image-placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--text-light);
}

.no-image-placeholder i {
  font-size: 2.5rem;
  margin-bottom: 0.5rem;
  opacity: 0.5;
}

.job-content {
  flex: 1;
  min-width: 0;
}

.job-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.75rem;
  gap: 1rem;
}

.job-title-link {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text-dark);
  text-decoration: none;
  transition: color 0.2s;
  line-height: 1.3;
}

.job-title-link:hover {
  color: var(--primary-color);
  text-decoration: none;
}

.job-status-badges {
  display: flex;
  gap: 0.5rem;
  flex-shrink: 0;
}

.status-badge {
  padding: 0.35rem 0.75rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
}

.status-badge.hiring {
  background: rgba(16, 185, 129, 0.1);
  color: var(--success-color);
}

.status-badge.closed {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger-color);
}

.status-badge.new {
  background: rgba(245, 158, 11, 0.1);
  color: var(--warning-color);
  animation: pulse-badge 2s infinite;
}

@keyframes pulse-badge {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
}

.job-meta-row {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  margin-bottom: 0.75rem;
  font-size: 0.9rem;
  color: var(--text-medium);
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.meta-item i {
  color: var(--primary-color);
  font-size: 0.95rem;
}

.job-description-preview {
  color: var(--text-medium);
  line-height: 1.6;
  margin-bottom: 1rem;
  font-size: 0.95rem;
}

.job-footer-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
}

.job-budget {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--success-color);
}

.job-actions {
  display: flex;
  gap: 0.75rem;
}

.btn-view-details {
  background: var(--gradient-primary);
  color: white;
  padding: 0.6rem 1.25rem;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
}

.btn-view-details:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
  color: white;
  text-decoration: none;
}

/* Grid View */
.jobs-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 1.5rem;
}

.job-card-grid {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  transition: all 0.3s;
}

.job-card-grid:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.job-image-grid {
  width: 100%;
  height: 200px;
  overflow: hidden;
  background: var(--bg-light);
  position: relative;
}

.job-image-grid img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s;
}

.job-card-grid:hover .job-image-grid img {
  transform: scale(1.05);
}

.job-card-body {
  padding: 1.25rem;
}

.timestamp-badge {
  position: absolute;
  top: 0.75rem;
  right: 0.75rem;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 0.35rem 0.75rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
  backdrop-filter: blur(10px);
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  background: white;
  border-radius: 12px;
  margin: 2rem 0;
}

.empty-state i {
  font-size: 4rem;
  color: var(--text-light);
  margin-bottom: 1rem;
  opacity: 0.5;
}

.empty-state h3 {
  color: var(--text-dark);
  margin-bottom: 0.5rem;
}

.empty-state p {
  color: var(--text-medium);
}

/* Pagination */
.pagination-wrapper {
  display: flex;
  justify-content: center;
  margin-top: 3rem;
}

.pagination {
  display: flex;
  gap: 0.5rem;
  list-style: none;
  padding: 0;
  margin: 0;
}

.page-item .page-link {
  padding: 0.6rem 1rem;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  color: var(--text-dark);
  text-decoration: none;
  background: white;
  transition: all 0.2s;
  font-weight: 500;
}

.page-item.active .page-link {
  background: var(--primary-color);
  border-color: var(--primary-color);
  color: white;
}

.page-item .page-link:hover {
  background: var(--primary-light);
  border-color: var(--primary-color);
  color: var(--primary-color);
  text-decoration: none;
}

/* Responsive */
@media (max-width: 768px) {
  .hero-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .hero-stats {
    width: 100%;
    justify-content: space-around;
  }
  
  .search-bar-compact {
    flex-direction: column;
    align-items: stretch;
  }
  
  .filter-toggle-btn,
  .search-btn-compact {
    width: 100%;
    justify-content: center;
  }
  
  .content-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .content-actions {
    width: 100%;
    flex-direction: column;
  }
  
  .sort-dropdown,
  .btn-primary-custom {
    width: 100%;
  }
  
  .job-card-list {
    flex-direction: column;
  }
  
  .job-thumbnail {
    width: 100%;
    height: 200px;
  }
  
  .job-footer-row {
    flex-direction: column;
    gap: 1rem;
    align-items: flex-start;
  }
  
  .job-actions {
    width: 100%;
  }
  
  .btn-view-details {
    width: 100%;
    justify-content: center;
  }
  
  .jobs-grid {
    grid-template-columns: 1fr;
  }
}

/* Loading Animation */
@keyframes shimmer {
  0% {
    background-position: -1000px 0;
  }
  100% {
    background-position: 1000px 0;
  }
}

.loading-skeleton {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 1000px 100%;
  animation: shimmer 2s infinite;
}
</style>

<!-- Compact Hero Section -->
<div class="compact-hero">
  <div class="container">
    <div class="hero-header">
      <div class="hero-title-section">
        <h1 id="heroTitle"><i class="bi bi-briefcase-fill"></i> Job Opportunities</h1>
        <p id="heroSubtitle">Find your next opportunity from {{ jobs_count }} available positions</p>
      </div>
      <div class="hero-stats">
        <div class="stat-item">
          <span class="stat-number" id="statNumber">{{ jobs_count }}</span>
          <span class="stat-label" id="statLabel">Active Jobs</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">{{ categories.count }}</span>
          <span class="stat-label">Categories</span>
        </div>
      </div>
    </div>
    
    <!-- Minimized Search Bar -->
    <form method="get" action="{% url 'jobs:job_list' %}" id="searchForm">
      <div class="search-bar-compact">
        <i class="bi bi-search" style="color: var(--text-light); font-size: 1.2rem;"></i>
        <input 
          type="text" 
          name="q" 
          value="{{ request.GET.q|default:'' }}" 
          placeholder="Search by job title, skills, or location..." 
          class="search-input-compact"
        >
        <button type="button" class="filter-toggle-btn" id="filterToggle">
          <i class="bi bi-funnel"></i>
          <span>Filters</span>
          <i class="bi bi-chevron-down" id="filterChevron"></i>
        </button>
        <button type="submit" class="search-btn-compact">
          <i class="bi bi-search"></i> Search
        </button>
      </div>
      
      <!-- Collapsible Filters Panel -->
      <div class="filters-panel" id="filtersPanel">
        <div class="filter-row">
          <div class="filter-group">
            <label><i class="bi bi-tag"></i> Category</label>
            <select name="category" class="form-select">
              <option value="">All Categories</option>
              {% for category in categories %}
              <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"i" %}selected{% endif %}>
                {{ category.name }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="filter-group">
            <label><i class="bi bi-geo-alt"></i> Municipality</label>
            <input type="text" name="municipality" value="{{ request.GET.municipality|default:'' }}" placeholder="Enter municipality">
          </div>
          <div class="filter-group">
            <label><i class="bi bi-map"></i> Barangay</label>
            <input type="text" name="barangay" value="{{ request.GET.barangay|default:'' }}" placeholder="Enter barangay">
          </div>
        </div>
        <div class="filter-row">
          <div class="filter-group">
            <label><i class="bi bi-cash"></i> Min Budget (₱)</label>
            <input type="number" name="min_budget" value="{{ request.GET.min_budget|default:'' }}" placeholder="0">
          </div>
          <div class="filter-group">
            <label><i class="bi bi-cash-stack"></i> Max Budget (₱)</label>
            <input type="number" name="max_budget" value="{{ request.GET.max_budget|default:'' }}" placeholder="No limit">
          </div>
          <div class="filter-group">
            <label><i class="bi bi-toggle-on"></i> Status</label>
            <select name="status">
              <option value="">All Status</option>
              <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Hiring</option>
              <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>Closed</option>
            </select>
          </div>
        </div>
        <div class="filter-actions">
          <a href="{% url 'jobs:job_list' %}" class="btn-primary-custom" style="background: var(--text-light);">
            <i class="bi bi-x-circle"></i> Clear Filters
          </a>
          <button type="submit" class="btn-primary-custom">
            <i class="bi bi-check-circle"></i> Apply Filters
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Tab Navigation -->
<div class="tab-nav-wrapper" style="background: white; border-bottom: 2px solid var(--border-color); margin-top: -1px;">
  <div class="container">
    <div class="tab-nav-modern" style="display: flex; gap: 0; padding: 0;">
      <button class="tab-btn-modern active" data-tab="jobs" id="jobsTabBtn" style="flex: 1; padding: 1rem 2rem; border: none; background: none; font-weight: 600; color: var(--text-medium); border-bottom: 3px solid transparent; transition: all 0.3s; cursor: pointer;">
        <i class="bi bi-briefcase"></i> Jobs ({{ jobs_count }})
      </button>
      <button class="tab-btn-modern" data-tab="services" id="servicesTabBtn" style="flex: 1; padding: 1rem 2rem; border: none; background: none; font-weight: 600; color: var(--text-medium); border-bottom: 3px solid transparent; transition: all 0.3s; cursor: pointer;">
        <i class="bi bi-tools"></i> Services ({{ services_count }})
      </button>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="main-wrapper">
  <div class="container">
    <!-- Jobs Section -->
    <div id="jobsContent" class="tab-content-section">
    <!-- Content Header -->
    <div class="content-header">
      <div class="results-info">
        <div class="results-count">
          <span>{{ jobs.count }}</span> Jobs Found
        </div>
        <div class="view-toggle">
          <button class="view-btn active" data-view="list" id="listViewBtn">
            <i class="bi bi-list-ul"></i>
          </button>
          <button class="view-btn" data-view="grid" id="gridViewBtn">
            <i class="bi bi-grid-3x3-gap"></i>
          </button>
        </div>
      </div>
      
      <div class="content-actions">
        <select class="sort-dropdown" onchange="sortJobs(this.value)">
          <option value="date_desc" {% if request.GET.sort == 'date_desc' or not request.GET.sort %}selected{% endif %}>
            <i class="bi bi-sort-down"></i> Newest First
          </option>
          <option value="date_asc" {% if request.GET.sort == 'date_asc' %}selected{% endif %}>
            <i class="bi bi-sort-up"></i> Oldest First
          </option>
          <option value="budget_desc" {% if request.GET.sort == 'budget_desc' %}selected{% endif %}>
            <i class="bi bi-cash"></i> Highest Budget
          </option>
          <option value="budget_asc" {% if request.GET.sort == 'budget_asc' %}selected{% endif %}>
            <i class="bi bi-cash"></i> Lowest Budget
          </option>
          {% if request.GET.lat and request.GET.lng %}
          <option value="distance" {% if request.GET.sort == 'distance' %}selected{% endif %}>
            <i class="bi bi-geo"></i> Nearest First
          </option>
          {% endif %}
        </select>
        
        {% if user.is_authenticated %}
        <a href="{% url 'jobs:job_create' %}" class="btn-primary-custom">
          <i class="bi bi-plus-circle"></i> Post a Job
        </a>
        {% endif %}
        <button class="btn-primary-custom" style="background: white; color: var(--primary-color); border: 2px solid var(--primary-color);" data-bs-toggle="modal" data-bs-target="#locationModal">
          <i class="bi bi-geo-alt"></i> Set Location
        </button>
      </div>
    </div>
    
    <!-- Jobs List View (Default) -->
    <div class="jobs-list" id="listView">
      {% for job in jobs %}
      <div class="job-card-list" data-lat="{{ job.location.y }}" data-lng="{{ job.location.x }}">
        <div class="job-thumbnail">
          {% if job.jobimage_set.exists %}
          <img src="{{ job.jobimage_set.first.image.url }}" alt="{{ job.title }}">
          {% else %}
          <div class="no-image-placeholder">
            <i class="bi bi-image"></i>
            <small>No image</small>
          </div>
          {% endif %}
          <div class="timestamp-badge">
            <i class="bi bi-clock"></i> {{ job.created_at|timesince }} ago
          </div>
        </div>
        
        <div class="job-content">
          <div class="job-header">
            <a href="{% url 'jobs:job_detail' job.id %}" class="job-title-link">
              {{ job.title }}
            </a>
            <div class="job-status-badges">
              {% if job.is_active %}
              <span class="status-badge hiring">
                <i class="bi bi-check-circle-fill"></i> Hiring
              </span>
              {% else %}
              <span class="status-badge closed">
                <i class="bi bi-x-circle-fill"></i> Closed
              </span>
              {% endif %}
              
              {% now "U" as current_timestamp %}
              {% if job.created_at|date:"U"|add:"86400" > current_timestamp %}
              <span class="status-badge new">
                <i class="bi bi-star-fill"></i> New
              </span>
              {% endif %}
            </div>
          </div>
          
          <div class="job-meta-row">
            <div class="meta-item">
              <i class="bi bi-building"></i>
              <span>{{ job.owner.username }}</span>
            </div>
            <div class="meta-item">
              <i class="bi bi-geo-alt-fill"></i>
              <span>{{ job.municipality }}{% if job.barangay %}, {{ job.barangay }}{% endif %}</span>
            </div>
            <div class="meta-item">
              <i class="bi bi-tag-fill"></i>
              <span>{{ job.category.name }}</span>
            </div>
            <div class="meta-item">
              <i class="bi bi-calendar-event"></i>
              <span>{{ job.created_at|date:"M d, Y" }}</span>
            </div>
            <div class="meta-item distance-display" style="color: var(--primary-color); font-weight: 600; display: none;">
              <i class="bi bi-geo-alt-fill"></i>
              <span>Calculating...</span>
            </div>
          </div>
          
          <p class="job-description-preview">
            {{ job.description|truncatechars:180 }}
          </p>
          
          <div class="job-footer-row">
            <div class="job-budget">
              <i class="bi bi-cash-stack"></i> ₱{{ job.budget|floatformat:0 }}
            </div>
            <div class="job-actions">
              <a href="{% url 'jobs:job_detail' job.id %}" class="btn-view-details">
                View Details <i class="bi bi-arrow-right"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="empty-state">
        <i class="bi bi-inbox"></i>
        <h3>No Jobs Found</h3>
        <p>Try adjusting your search criteria or check back later for new opportunities.</p>
      </div>
      {% endfor %}
    </div>
    
    <!-- Jobs Grid View (Hidden by default) -->
    <div class="jobs-grid" id="gridView" style="display: none;">
      {% for job in jobs %}
      <div class="job-card-grid" data-lat="{{ job.location.y }}" data-lng="{{ job.location.x }}">
        <div class="job-image-grid">
          {% if job.jobimage_set.exists %}
          <img src="{{ job.jobimage_set.first.image.url }}" alt="{{ job.title }}">
          {% else %}
          <div class="no-image-placeholder">
            <i class="bi bi-image"></i>
            <small>No image</small>
          </div>
          {% endif %}
          <div class="timestamp-badge">
            <i class="bi bi-clock"></i> {{ job.created_at|timesince }} ago
          </div>
        </div>
        
        <div class="job-card-body">
          <div class="job-status-badges" style="margin-bottom: 0.75rem;">
            {% if job.is_active %}
            <span class="status-badge hiring">
              <i class="bi bi-check-circle-fill"></i> Hiring
            </span>
            {% else %}
            <span class="status-badge closed">
              <i class="bi bi-x-circle-fill"></i> Closed
            </span>
            {% endif %}
          </div>
          
          <a href="{% url 'jobs:job_detail' job.id %}" class="job-title-link" style="font-size: 1.1rem;">
            {{ job.title|truncatechars:50 }}
          </a>
          
          <div class="job-meta-row" style="margin-top: 0.75rem; margin-bottom: 0.75rem;">
            <div class="meta-item">
              <i class="bi bi-geo-alt-fill"></i>
              <span>{{ job.municipality }}</span>
            </div>
            <div class="meta-item">
              <i class="bi bi-calendar-event"></i>
              <span>{{ job.created_at|date:"M d" }}</span>
            </div>
            <div class="meta-item distance-display" style="color: var(--primary-color); font-weight: 600; display: none;">
              <i class="bi bi-geo-alt-fill"></i>
              <span>Calculating...</span>
            </div>
          </div>
          
          <p class="job-description-preview" style="font-size: 0.85rem;">
            {{ job.description|truncatechars:100 }}
          </p>
          
          <div class="job-footer-row">
            <div class="job-budget" style="font-size: 1.25rem;">
              ₱{{ job.budget|floatformat:0 }}
            </div>
            <a href="{% url 'jobs:job_detail' job.id %}" class="btn-view-details" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
              View <i class="bi bi-arrow-right"></i>
            </a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if is_paginated %}
    <div class="pagination-wrapper">
      <nav>
        <ul class="pagination">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}page=1">
              <i class="bi bi-chevron-double-left"></i>
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">
              <i class="bi bi-chevron-left"></i>
            </a>
          </li>
          {% endif %}
          
          {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
          <li class="page-item active">
            <span class="page-link">{{ num }}</span>
          </li>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <li class="page-item">
            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
          </li>
          {% endif %}
          {% endfor %}
          
          {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">
              <i class="bi bi-chevron-right"></i>
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}">
              <i class="bi bi-chevron-double-right"></i>
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}
    </div>
    <!-- End Jobs Section -->
    
    <!-- Services Section -->
    <div id="servicesContent" class="tab-content-section" style="display: none;">
      <!-- Content Header -->
      <div class="content-header">
        <div class="results-info">
          <div class="results-count">
            <span>{{ services.count }}</span> Services Found
          </div>
        </div>
        
        <div class="content-actions">
          {% if user.is_authenticated %}
          <a href="{% url 'services:servicepost_create' %}" class="btn-primary-custom">
            <i class="bi bi-plus-circle"></i> Post a Service
          </a>
          {% endif %}
          <button class="btn-primary-custom" style="background: white; color: var(--primary-color); border: 2px solid var(--primary-color);" data-bs-toggle="modal" data-bs-target="#locationModal">
            <i class="bi bi-geo-alt"></i> Set Location
          </button>
        </div>
      </div>
      
      <!-- Services List -->
      <div class="jobs-list">
        {% for service in services %}
        <div class="job-card-list">
          <div class="job-thumbnail">
            {% with service.images.first as service_image %}
            {% if service_image %}
            <img src="{{ service_image.image.url }}" alt="{{ service.headline }}">
            {% else %}
            <div class="no-image-placeholder">
              <i class="bi bi-tools"></i>
              <small>No image</small>
            </div>
            {% endif %}
            {% endwith %}
            <div class="timestamp-badge">
              <i class="bi bi-clock"></i> {{ service.created_at|timesince }} ago
            </div>
          </div>
          
          <div class="job-content">
            <div class="job-header">
              <a href="{{ service.get_absolute_url }}" class="job-title-link">
                {{ service.headline }}
              </a>
              <div class="job-status-badges">
                <span class="status-badge hiring" style="background: rgba(59, 130, 246, 0.1); color: var(--primary-color);">
                  <i class="bi bi-tools"></i> Service
                </span>
              </div>
            </div>
            
            <div class="job-meta-row">
              <div class="meta-item">
                <i class="bi bi-person-circle"></i>
                <span>{{ service.user.username }}</span>
              </div>
              <div class="meta-item">
                <i class="bi bi-calendar-event"></i>
                <span>{{ service.created_at|date:"M d, Y" }}</span>
              </div>
              {% if service.distance %}
              <div class="meta-item" style="color: var(--success-color);">
                <i class="bi bi-geo"></i>
                <span>{{ service.distance.km|floatformat:1 }} km away</span>
              </div>
              {% endif %}
            </div>
            
            <p class="job-description-preview">
              {{ service.description|truncatechars:180 }}
            </p>
            
            <div class="job-footer-row">
              <div class="job-budget" style="font-size: 1.1rem; color: var(--primary-color);">
                <i class="bi bi-tools"></i> Professional Service
              </div>
              <div class="job-actions">
                <a href="{{ service.get_absolute_url }}" class="btn-view-details">
                  View Details <i class="bi bi-arrow-right"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="empty-state">
          <i class="bi bi-tools"></i>
          <h3>No Services Found</h3>
          <p>Check back later for new service opportunities.</p>
        </div>
        {% endfor %}
      </div>
    </div>
    <!-- End Services Section -->
    
  </div>
</div>

<style>
.tab-btn-modern.active {
  color: var(--primary-color) !important;
  border-bottom-color: var(--primary-color) !important;
}

.tab-btn-modern:hover {
  color: var(--primary-color);
  background: var(--primary-light);
}
</style>

<script>
// Tab Switching
const jobsTabBtn = document.getElementById('jobsTabBtn');
const servicesTabBtn = document.getElementById('servicesTabBtn');
const jobsContent = document.getElementById('jobsContent');
const servicesContent = document.getElementById('servicesContent');
const heroTitle = document.getElementById('heroTitle');
const heroSubtitle = document.getElementById('heroSubtitle');
const statNumber = document.getElementById('statNumber');
const statLabel = document.getElementById('statLabel');

jobsTabBtn.addEventListener('click', function() {
  jobsTabBtn.classList.add('active');
  servicesTabBtn.classList.remove('active');
  jobsContent.style.display = 'block';
  servicesContent.style.display = 'none';
  
  heroTitle.innerHTML = '<i class="bi bi-briefcase-fill"></i> Job Opportunities';
  heroSubtitle.textContent = 'Find your next opportunity from {{ jobs_count }} available positions';
  statNumber.textContent = '{{ jobs_count }}';
  statLabel.textContent = 'Active Jobs';
  
  // Update URL
  const url = new URL(window.location.href);
  url.searchParams.set('tab', 'jobs');
  window.history.pushState({}, '', url);
});

servicesTabBtn.addEventListener('click', function() {
  servicesTabBtn.classList.add('active');
  jobsTabBtn.classList.remove('active');
  servicesContent.style.display = 'block';
  jobsContent.style.display = 'none';
  
  heroTitle.innerHTML = '<i class="bi bi-tools"></i> Professional Services';
  heroSubtitle.textContent = 'Discover skilled professionals ready to help';
  statNumber.textContent = '{{ services.count }}';
  statLabel.textContent = 'Services';
  
  // Update URL
  const url = new URL(window.location.href);
  url.searchParams.set('tab', 'services');
  window.history.pushState({}, '', url);
});

// Check URL parameter on load
const urlParams = new URLSearchParams(window.location.search);
const activeTab = urlParams.get('tab');
if (activeTab === 'services') {
  servicesTabBtn.click();
}

// Filter Toggle
document.getElementById('filterToggle').addEventListener('click', function() {
  const panel = document.getElementById('filtersPanel');
  const chevron = document.getElementById('filterChevron');
  const button = this;
  
  if (panel.classList.contains('show')) {
    panel.classList.remove('show');
    chevron.classList.remove('bi-chevron-up');
    chevron.classList.add('bi-chevron-down');
    button.classList.remove('active');
  } else {
    panel.classList.add('show');
    chevron.classList.remove('bi-chevron-down');
    chevron.classList.add('bi-chevron-up');
    button.classList.add('active');
  }
});

// View Toggle
const listViewBtn = document.getElementById('listViewBtn');
const gridViewBtn = document.getElementById('gridViewBtn');
const listView = document.getElementById('listView');
const gridView = document.getElementById('gridView');

listViewBtn.addEventListener('click', function() {
  listView.style.display = 'flex';
  gridView.style.display = 'none';
  listViewBtn.classList.add('active');
  gridViewBtn.classList.remove('active');
  localStorage.setItem('jobViewPreference', 'list');
});

gridViewBtn.addEventListener('click', function() {
  listView.style.display = 'none';
  gridView.style.display = 'grid';
  gridViewBtn.classList.add('active');
  listViewBtn.classList.remove('active');
  localStorage.setItem('jobViewPreference', 'grid');
});

// Restore view preference
const savedView = localStorage.getItem('jobViewPreference');
if (savedView === 'grid') {
  gridViewBtn.click();
}

// Sort Function
function sortJobs(sortValue) {
  const url = new URL(window.location.href);
  url.searchParams.set('sort', sortValue);
  url.searchParams.set('page', '1'); // Reset to first page
  window.location.href = url.toString();
}

// Location Functions
function getCurrentLocation() {
  const statusDiv = document.getElementById('locationStatus');
  const activeTab = urlParams.get('tab') || 'jobs';
  
  statusDiv.style.display = 'block';
  statusDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-arrow-repeat spin"></i> <span>Getting your location...</span></div>';

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        
        const url = new URL(window.location);
        url.searchParams.set('lat', lat);
        url.searchParams.set('lng', lng);
        url.searchParams.set('tab', activeTab);
        
        statusDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> <span>Location detected successfully!</span></div>';
        
        setTimeout(() => {
          const modal = bootstrap.Modal.getInstance(document.getElementById('locationModal'));
          modal.hide();
          window.location.href = url.toString();
        }, 1500);
      },
      function(error) {
        let errorMessage = 'Unable to get your location. ';
        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMessage += 'Please allow location access.';
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage += 'Location information unavailable.';
            break;
          case error.TIMEOUT:
            errorMessage += 'Location request timed out.';
            break;
          default:
            errorMessage += 'An unknown error occurred.';
            break;
        }
        
        statusDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> <span>${errorMessage}</span></div>`;
      }
    );
  } else {
    statusDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> <span>Geolocation is not supported by this browser.</span></div>';
  }
}

function applyManualLocation() {
  const city = document.getElementById('manualCity').value.trim();
  const barangay = document.getElementById('manualBarangay').value.trim();
  const activeTab = urlParams.get('tab') || 'jobs';
  
  if (!city) {
    alert('Please enter a city or municipality.');
    return;
  }
  
  const url = new URL(window.location);
  url.searchParams.set('municipality', city);
  if (barangay) {
    url.searchParams.set('barangay', barangay);
  }
  url.searchParams.delete('lat');
  url.searchParams.delete('lng');
  url.searchParams.set('tab', activeTab);
  
  const modal = bootstrap.Modal.getInstance(document.getElementById('locationModal'));
  modal.hide();
  window.location.href = url.toString();
}
</script>

<!-- Location Modal -->
<div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 12px; border: none;">
      <div class="modal-header" style="background: var(--gradient-primary); color: white; border: none;">
        <h5 class="modal-title" id="locationModalLabel">
          <i class="bi bi-geo-alt"></i> Set Your Location
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding: 2rem;">
        <p style="color: var(--text-medium); margin-bottom: 1.5rem;">Choose how you'd like to set your location to find opportunities near you.</p>
        
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <button type="button" onclick="getCurrentLocation()" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 2px solid var(--border-color); border-radius: 10px; background: white; cursor: pointer; transition: all 0.2s;">
            <div style="width: 50px; height: 50px; background: var(--gradient-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              <i class="bi bi-crosshairs" style="font-size: 1.5rem;"></i>
            </div>
            <div style="text-align: left; flex: 1;">
              <h6 style="margin: 0 0 0.25rem 0; color: var(--text-dark); font-weight: 600;">Use Current Location</h6>
              <small style="color: var(--text-light);">Automatically detect your location</small>
            </div>
          </button>
          
          <div style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; border: 2px solid var(--border-color); border-radius: 10px; background: white;">
            <div style="width: 50px; height: 50px; background: var(--gradient-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              <i class="bi bi-pencil" style="font-size: 1.5rem;"></i>
            </div>
            <div style="flex: 1;">
              <h6 style="margin: 0 0 0.75rem 0; color: var(--text-dark); font-weight: 600;">Enter Manually</h6>
              <input type="text" class="form-control mb-2" id="manualCity" placeholder="Enter city/municipality" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 0.6rem;">
              <input type="text" class="form-control" id="manualBarangay" placeholder="Enter barangay (optional)" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 0.6rem;">
            </div>
          </div>
        </div>
        
        <div id="locationStatus" style="margin-top: 1rem; display: none;"></div>
      </div>
      <div class="modal-footer" style="border: none; padding: 1rem 2rem;">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 8px;">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="applyManualLocation()" style="background: var(--gradient-primary); border: none; border-radius: 8px;">Apply Location</button>
      </div>
    </div>
  </div>
</div>

<style>
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
.spin {
  animation: spin 1s linear infinite;
}
</style>

<script>
// LocationManager - Auto-detect and display distances
const LocationManager = {
    CACHE_KEY: 'trabaholink_user_location',
    CACHE_DURATION: 24 * 60 * 60 * 1000, // 24 hours
    
    getCachedLocation() {
        const cached = localStorage.getItem(this.CACHE_KEY);
        if (!cached) return null;
        
        try {
            const location = JSON.parse(cached);
            if (Date.now() - location.timestamp > this.CACHE_DURATION) {
                localStorage.removeItem(this.CACHE_KEY);
                return null;
            }
            return location;
        } catch (e) {
            return null;
        }
    },
    
    async getCurrentLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('Geolocation not supported'));
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const location = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(this.CACHE_KEY, JSON.stringify(location));
                    resolve(location);
                },
                (error) => {
                    console.log('Location error:', error.message);
                    reject(error);
                },
                { 
                    enableHighAccuracy: false,
                    timeout: 10000,
                    maximumAge: 300000 // 5 minutes
                }
            );
        });
    },
    
    calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },
    
    formatDistance(km) {
        if (km < 1) {
            return Math.round(km * 1000) + 'm away';
        } else if (km < 10) {
            return km.toFixed(1) + 'km away';
        } else {
            return Math.round(km) + 'km away';
        }
    },
    
    async initializeDistances() {
        try {
            // Try to get cached location first
            let location = this.getCachedLocation();
            
            // If no cache, get current location
            if (!location) {
                console.log('Getting current location...');
                location = await this.getCurrentLocation();
            }
            
            if (location) {
                console.log('User location:', location);
                this.updateDistances(location);
            }
        } catch (error) {
            console.log('Could not get location:', error.message);
            // Hide all distance displays if location unavailable
            document.querySelectorAll('.distance-display').forEach(el => {
                el.style.display = 'none';
            });
        }
    },
    
    updateDistances(userLocation) {
        const jobCards = document.querySelectorAll('[data-lat][data-lng]');
        
        jobCards.forEach(card => {
            const jobLat = parseFloat(card.dataset.lat);
            const jobLng = parseFloat(card.dataset.lng);
            
            if (!isNaN(jobLat) && !isNaN(jobLng)) {
                const distance = this.calculateDistance(
                    userLocation.latitude,
                    userLocation.longitude,
                    jobLat,
                    jobLng
                );
                
                const distanceDisplay = card.querySelector('.distance-display');
                if (distanceDisplay) {
                    const span = distanceDisplay.querySelector('span');
                    if (span) {
                        span.textContent = this.formatDistance(distance);
                    }
                    distanceDisplay.style.display = 'flex';
                }
            }
        });
    }
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    LocationManager.initializeDistances();
});
</script>

{% endblock %}
