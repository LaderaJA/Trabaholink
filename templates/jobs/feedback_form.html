{% extends "mainpages/base.html" %}
{% load static %}

{% block title %}Leave Feedback - {{ contract.job.title }}{% endblock %}

{% block css %}
{{ block.super }}
<script src="https://cdn.tailwindcss.com"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-3xl">
    <!-- Back Button -->
    <div class="mb-4">
        <a href="{% url 'jobs:contract_detail' contract.pk %}" class="inline-flex items-center gap-2 px-4 py-2 bg-white border-2 border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
            <i class="bi bi-arrow-left"></i>
            <span class="font-medium">Back to Contract</span>
        </a>
    </div>

    <!-- Header Card -->
    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl shadow-lg p-8 mb-6 text-white">
        <div class="text-center">
            <div class="text-7xl mb-4 animate-bounce">⭐</div>
            <h1 class="text-4xl font-bold mb-3">Leave Feedback</h1>
            <p class="text-blue-100 text-lg">{{ contract.job.title }}</p>
        </div>
    </div>

    <!-- Receiver Info Card -->
    <div class="bg-white rounded-xl shadow-md border-2 border-blue-200 p-6 mb-6">
        <div class="flex items-start gap-4">
            <div class="bg-blue-100 rounded-full p-3">
                <i class="bi bi-person-circle text-3xl text-blue-600"></i>
            </div>
            <div class="flex-1">
                <p class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-1">Leaving feedback for:</p>
                <p class="text-2xl font-bold text-gray-900 mb-2">
                    {{ receiver.get_full_name|default:receiver.username }}
                </p>
                <p class="text-gray-600">
                    {% if is_worker %}
                        <i class="bi bi-briefcase text-blue-500"></i> Rate your experience working with this employer
                    {% else %}
                        <i class="bi bi-tools text-blue-500"></i> Rate your experience with this worker
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Feedback Form Card -->
    <div class="bg-white rounded-xl shadow-lg border-2 border-gray-200 p-8 mb-6">
        <form method="post" id="feedback-form">
            {% csrf_token %}
            
            <!-- Rating Section -->
            <div class="mb-8">
                <label class="block text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="bi bi-star-fill text-yellow-500"></i>
                    Rating *
                </label>
                <div class="bg-gray-50 rounded-xl p-6 border-2 border-gray-200">
                    <div class="flex justify-center gap-3 mb-3">
                    <input type="radio" name="rating" value="1" id="star1" class="hidden" required>
                    <label for="star1" class="star-label text-5xl cursor-pointer transition-transform hover:scale-110" data-rating="1">☆</label>
                    
                    <input type="radio" name="rating" value="2" id="star2" class="hidden">
                    <label for="star2" class="star-label text-5xl cursor-pointer transition-transform hover:scale-110" data-rating="2">☆</label>
                    
                    <input type="radio" name="rating" value="3" id="star3" class="hidden">
                    <label for="star3" class="star-label text-5xl cursor-pointer transition-transform hover:scale-110" data-rating="3">☆</label>
                    
                    <input type="radio" name="rating" value="4" id="star4" class="hidden">
                    <label for="star4" class="star-label text-5xl cursor-pointer transition-transform hover:scale-110" data-rating="4">☆</label>
                    
                    <input type="radio" name="rating" value="5" id="star5" class="hidden">
                    <label for="star5" class="star-label text-5xl cursor-pointer transition-transform hover:scale-110" data-rating="5">☆</label>
                    </div>
                    <p class="text-center text-lg font-semibold text-gray-700" id="rating-text">Click to rate</p>
                </div>
            </div>

            <!-- Feedback Message -->
            <div class="mb-8">
                <label for="message" class="block text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="bi bi-chat-left-text-fill text-blue-500"></i>
                    Your Feedback *
                </label>
                <textarea name="message" id="message" required
                          class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-200 focus:border-blue-500 transition-all text-base"
                          rows="8" 
                          placeholder="Share your experience working together..."></textarea>
                <div class="flex items-start gap-2 mt-3 bg-blue-50 border-l-4 border-blue-400 p-3 rounded">
                    <i class="bi bi-info-circle text-blue-600 mt-0.5"></i>
                    <p class="text-sm text-blue-800">
                        Be honest and constructive. Your feedback helps build trust in the community.
                    </p>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="flex flex-col sm:flex-row gap-4">
                <button type="submit" 
                        class="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-4 px-8 rounded-xl transition-all duration-200 flex items-center justify-center gap-3 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <i class="bi bi-send-fill text-xl"></i>
                    <span class="text-lg">Submit Feedback</span>
                </button>
                
                <a href="{% url 'jobs:contract_detail' contract.pk %}" 
                   class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-4 px-8 rounded-xl transition-all duration-200 text-center border-2 border-gray-300 hover:border-gray-400 flex items-center justify-center gap-2">
                    <i class="bi bi-skip-forward"></i>
                    <span>Skip for Now</span>
                </a>
            </div>
        </form>
    </div>

    <!-- Info Box -->
    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-400 rounded-xl p-6 shadow-md">
        <div class="flex items-start gap-4">
            <div class="bg-yellow-400 rounded-full p-2 flex-shrink-0">
                <i class="bi bi-exclamation-triangle-fill text-white text-xl"></i>
            </div>
            <div>
                <p class="font-bold text-gray-900 mb-2 text-lg">Important Note</p>
                <p class="text-gray-700">
                    Your feedback will be <strong>publicly visible</strong> on the user's profile and helps other users make informed decisions. 
                    Please be respectful and honest.
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    .star-label {
        color: #d1d5db;
        user-select: none;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    .star-label.active,
    .star-label.hover {
        color: #fbbf24;
        filter: drop-shadow(0 4px 8px rgba(251, 191, 36, 0.4));
    }

    textarea:focus {
        outline: none;
    }

    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    .animate-bounce {
        animation: bounce 2s infinite;
    }
</style>

<script>
    // Star rating functionality
    const stars = document.querySelectorAll('.star-label');
    const ratingInputs = document.querySelectorAll('input[name="rating"]');
    const ratingText = document.getElementById('rating-text');
    let selectedRating = 0;

    const ratingDescriptions = {
        1: 'Poor - Not satisfied',
        2: 'Fair - Below expectations',
        3: 'Good - Met expectations',
        4: 'Very Good - Exceeded expectations',
        5: 'Excellent - Outstanding!'
    };

    // Handle star click
    stars.forEach((star, index) => {
        star.addEventListener('click', () => {
            selectedRating = index + 1;
            ratingInputs[index].checked = true;
            updateStars(selectedRating);
            ratingText.textContent = ratingDescriptions[selectedRating];
        });

        // Handle hover
        star.addEventListener('mouseenter', () => {
            updateStars(index + 1, true);
        });
    });

    // Reset on mouse leave
    document.querySelector('.flex.justify-center').addEventListener('mouseleave', () => {
        updateStars(selectedRating);
        if (selectedRating > 0) {
            ratingText.textContent = ratingDescriptions[selectedRating];
        } else {
            ratingText.textContent = 'Click to rate';
        }
    });

    function updateStars(rating, isHover = false) {
        stars.forEach((star, index) => {
            star.classList.remove('active', 'hover');
            if (index < rating) {
                star.classList.add(isHover ? 'hover' : 'active');
                star.textContent = '★';
            } else {
                star.textContent = '☆';
            }
        });
    }

    // Form validation
    const form = document.getElementById('feedback-form');
    form.addEventListener('submit', (e) => {
        const rating = document.querySelector('input[name="rating"]:checked');
        const message = document.getElementById('message').value.trim();

        if (!rating) {
            e.preventDefault();
            alert('Please select a rating.');
            return;
        }

        if (!message) {
            e.preventDefault();
            alert('Please write your feedback message.');
            return;
        }

        if (message.length < 10) {
            e.preventDefault();
            alert('Please write a more detailed feedback (at least 10 characters).');
            return;
        }

        // Confirmation
        const confirmed = confirm('Are you sure you want to submit this feedback? This action cannot be undone.');
        if (!confirmed) {
            e.preventDefault();
        }
    });

    // Character counter
    const messageTextarea = document.getElementById('message');
    messageTextarea.addEventListener('input', () => {
        const length = messageTextarea.value.length;
        if (length < 10) {
            messageTextarea.style.borderColor = '#ef4444';
        } else {
            messageTextarea.style.borderColor = '#d1d5db';
        }
    });
</script>
{% endblock %}
