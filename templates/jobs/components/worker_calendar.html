{% load static %}

<!-- Worker Calendar Component -->
<div class="calendar-container">
  <style>
    .calendar-container {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      max-width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .calendar-wrapper {
      min-width: 100%;
      width: 100%;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .calendar-nav {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .calendar-nav button {
      background: #1e3a8a;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
    }

    .calendar-nav button:hover {
      background: #1e40af;
    }

    .calendar-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e293b;
    }

    .calendar-view-toggle {
      display: flex;
      gap: 0.25rem;
      background: #f1f5f9;
      padding: 0.25rem;
      border-radius: 6px;
    }

    .view-btn {
      background: transparent;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.875rem;
      color: #64748b;
      transition: all 0.2s;
    }

    .view-btn.active {
      background: white;
      color: #1e3a8a;
      font-weight: 600;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(40px, 1fr));
      gap: 1px;
      background: #e2e8f0;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      overflow: hidden;
      min-width: 100%;
    }

    .calendar-day-header {
      background: #f8fafc;
      padding: 0.75rem;
      text-align: center;
      font-weight: 600;
      font-size: 0.875rem;
      color: #475569;
    }

    .calendar-day {
      background: white;
      min-height: 100px;
      padding: 0.5rem;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .calendar-day:hover {
      background: #f8fafc;
    }

    .calendar-day.other-month {
      background: #f8fafc;
      color: #94a3b8;
    }

    .calendar-day.today {
      background: #eff6ff;
      border: 2px solid #3b82f6;
    }

    .day-number {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: #1e293b;
    }

    .day-events {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .calendar-event {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      color: white;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .calendar-event:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .event-in-progress {
      background: #10b981;
    }

    .event-finalized {
      background: #3b82f6;
    }

    .event-negotiation {
      background: #f59e0b;
    }

    .event-awaiting {
      background: #8b5cf6;
    }

    .event-completed {
      background: #6b7280;
    }

    /* List View */
    .calendar-list-view {
      display: none;
    }

    .calendar-list-view.active {
      display: block;
    }

    .calendar-grid.hidden {
      display: none;
    }

    .list-event-item {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      transition: all 0.2s;
    }

    .list-event-item:hover {
      border-color: #3b82f6;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
    }

    .list-event-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 0.5rem;
    }

    .list-event-title {
      font-weight: 600;
      color: #1e293b;
      font-size: 1rem;
    }

    .list-event-status {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      color: white;
      font-weight: 600;
    }

    .list-event-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.5rem;
      margin-top: 0.75rem;
      font-size: 0.875rem;
      color: #64748b;
    }

    .list-event-detail {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Event Modal */
    .event-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .event-modal.active {
      display: flex;
    }

    .event-modal-content {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .event-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .event-modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e293b;
    }

    .event-modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #64748b;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
    }

    .event-modal-close:hover {
      background: #f1f5f9;
    }

    .event-modal-body {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .event-detail-row {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .event-detail-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: #64748b;
    }

    .event-detail-value {
      font-size: 1rem;
      color: #1e293b;
    }

    .event-modal-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e2e8f0;
    }

    .event-modal-btn {
      flex: 1;
      padding: 0.75rem;
      border-radius: 6px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .event-modal-btn-primary {
      background: #1e3a8a;
      color: white;
    }

    .event-modal-btn-primary:hover {
      background: #1e40af;
    }

    /* Loading State */
    .calendar-loading {
      text-align: center;
      padding: 3rem;
      color: #64748b;
    }

    .calendar-loading i {
      font-size: 2rem;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .calendar-container {
        padding: 1rem;
        margin: 0;
        border-radius: 12px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .calendar-wrapper {
        min-width: 100%;
        width: 100%;
        padding: 0;
      }

      .calendar-header {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
      }

      .calendar-nav {
        justify-content: space-between;
        flex-wrap: nowrap;
        overflow-x: auto;
      }

      .calendar-nav button {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
        white-space: nowrap;
        flex-shrink: 0;
        min-height: 44px;
        min-width: 44px;
      }

      .calendar-title {
        text-align: center;
        font-size: 1rem;
        order: -1;
      }

      .calendar-view-toggle {
        width: 100%;
      }

      .view-btn {
        flex: 1;
        font-size: 0.75rem;
        padding: 0.5rem 0.25rem;
        min-height: 44px;
      }

      .calendar-grid {
        gap: 0;
        min-width: 100%;
        grid-template-columns: repeat(7, 1fr);
      }

      .calendar-day {
        min-height: 80px;
        padding: 0.25rem;
        font-size: 0.75rem;
      }

      .calendar-day-header {
        padding: 0.5rem 0.125rem;
        font-size: 0.7rem;
      }

      .day-number {
        font-size: 0.75rem;
        margin-bottom: 0.125rem;
      }

      .calendar-event {
        font-size: 0.75rem;
        padding: 0.125rem 0.25rem;
        margin-bottom: 0.125rem;
      }

      .event-modal-content {
        padding: 1rem;
        width: 95%;
        max-width: 95vw;
      }

      .event-modal-title {
        font-size: 1rem;
      }

      .event-detail-label {
        font-size: 0.75rem;
      }

      .event-detail-value {
        font-size: 0.875rem;
      }

      .list-event-item {
        padding: 0.75rem;
      }

      .list-event-title {
        font-size: 0.9rem;
      }

      .list-event-details {
        grid-template-columns: 1fr;
        gap: 0.375rem;
        font-size: 0.75rem;
      }

      .list-event-status {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
      }
    }

    @media (max-width: 480px) {
      .calendar-container {
        padding: 1rem 0.75rem;
        margin: 0;
        border-radius: 12px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .calendar-wrapper {
        min-width: 100%;
        width: 100%;
        padding: 0;
      }
      
      .calendar-grid {
        min-width: 100%;
        grid-template-columns: repeat(7, 1fr);
      }

      .calendar-header {
        gap: 0.5rem;
      }

      .calendar-title {
        font-size: 0.9rem;
      }

      .calendar-nav {
        gap: 0.25rem;
      }

      .calendar-nav button {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
        border-radius: 4px;
        min-height: 44px;
        min-width: 44px;
      }

      .view-btn {
        font-size: 0.75rem;
        padding: 0.5rem 0.25rem;
        min-height: 44px;
      }

      .calendar-day {
        min-height: 70px;
        padding: 0.25rem;
      }

      .calendar-day-header {
        padding: 0.5rem 0.25rem;
        font-size: 0.75rem;
      }

      .day-number {
        font-size: 0.875rem;
      }

      .calendar-event {
        font-size: 0.75rem;
        padding: 0.125rem 0.25rem;
        display: block; /* Show events on small screens */
      }

      .calendar-day.has-events::after {
        content: '•';
        position: absolute;
        bottom: 4px;
        left: 50%;
        transform: translateX(-50%);
        color: #3b82f6;
        font-size: 1.25rem;
      }

      .list-event-item {
        padding: 0.625rem;
        margin-bottom: 0.5rem;
      }

      .list-event-title {
        font-size: 0.85rem;
      }

      .list-event-details {
        font-size: 0.7rem;
      }

      .event-modal-btn {
        padding: 0.625rem;
        font-size: 0.8rem;
      }
    }
  </style>

  <div class="calendar-wrapper">
  <!-- Calendar Header -->
  <div class="calendar-header">
    <div class="calendar-nav">
      <button onclick="previousMonth()" title="Previous Month">
        <i class="bi bi-chevron-left"></i>
      </button>
      <div class="calendar-title" id="calendarTitle">Loading...</div>
      <button onclick="nextMonth()" title="Next Month">
        <i class="bi bi-chevron-right"></i>
      </button>
      <button onclick="goToToday()" title="Today">Today</button>
    </div>
    
    <div class="calendar-view-toggle">
      <button class="view-btn active" onclick="switchView('month')" data-view="month">Month</button>
      <button class="view-btn" onclick="switchView('list')" data-view="list">List</button>
    </div>
  </div>

  <!-- Loading State -->
  <div class="calendar-loading" id="calendarLoading">
    <i class="bi bi-arrow-repeat"></i>
    <p>Loading your schedule...</p>
  </div>

  <!-- Calendar Grid View -->
  <div class="calendar-grid" id="calendarGrid" style="display: none;">
    <!-- Day headers -->
    <div class="calendar-day-header">Sun</div>
    <div class="calendar-day-header">Mon</div>
    <div class="calendar-day-header">Tue</div>
    <div class="calendar-day-header">Wed</div>
    <div class="calendar-day-header">Thu</div>
    <div class="calendar-day-header">Fri</div>
    <div class="calendar-day-header">Sat</div>
    
    <!-- Days will be inserted here by JavaScript -->
  </div>

  <!-- List View -->
  <div class="calendar-list-view" id="calendarListView">
    <!-- Events will be inserted here by JavaScript -->
  </div>

  <!-- Event Detail Modal -->
  <div class="event-modal" id="eventModal" onclick="closeEventModal(event)">
    <div class="event-modal-content" onclick="event.stopPropagation()">
      <div class="event-modal-header">
        <h3 class="event-modal-title" id="modalTitle">Contract Details</h3>
        <button class="event-modal-close" onclick="closeEventModal()">×</button>
      </div>
      <div class="event-modal-body" id="modalBody">
        <!-- Content will be inserted by JavaScript -->
      </div>
      <div class="event-modal-actions">
        <a href="#" class="event-modal-btn event-modal-btn-primary" id="modalViewBtn">View Contract</a>
      </div>
    </div>
  </div>
  </div>
</div>

<script>
let currentDate = new Date();
let currentView = 'month';
let allEvents = [];

// Initialize calendar on page load
document.addEventListener('DOMContentLoaded', function() {
  loadCalendarEvents();
});

function loadCalendarEvents() {
  const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
  const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
  
  fetch(`/jobs/api/worker/calendar/?start=${startOfMonth.toISOString()}&end=${endOfMonth.toISOString()}`)
    .then(response => response.json())
    .then(events => {
      allEvents = events;
      renderCalendar();
    })
    .catch(error => {
      console.error('Error loading calendar:', error);
      document.getElementById('calendarLoading').innerHTML = '<p style="color: #ef4444;">Failed to load calendar. Please refresh the page.</p>';
    });
}

function renderCalendar() {
  document.getElementById('calendarLoading').style.display = 'none';
  document.getElementById('calendarGrid').style.display = 'grid';
  
  if (currentView === 'month') {
    renderMonthView();
  } else {
    renderListView();
  }
}

function renderMonthView() {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  
  // Update title
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];
  document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;
  
  // Calculate calendar grid
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const daysInPrevMonth = new Date(year, month, 0).getDate();
  
  const grid = document.getElementById('calendarGrid');
  
  // Keep only the day headers
  while (grid.children.length > 7) {
    grid.removeChild(grid.lastChild);
  }
  
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  
  // Add previous month days
  for (let i = firstDay - 1; i >= 0; i--) {
    const day = daysInPrevMonth - i;
    const dayCell = createDayCell(day, true, year, month - 1);
    grid.appendChild(dayCell);
  }
  
  // Add current month days
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const isToday = dateStr === todayStr;
    const dayCell = createDayCell(day, false, year, month, isToday);
    grid.appendChild(dayCell);
  }
  
  // Add next month days to fill grid
  const totalCells = grid.children.length - 7;
  const remainingCells = 42 - totalCells; // 6 rows * 7 days
  for (let day = 1; day <= remainingCells; day++) {
    const dayCell = createDayCell(day, true, year, month + 1);
    grid.appendChild(dayCell);
  }
}

function createDayCell(day, isOtherMonth, year, month, isToday = false) {
  const cell = document.createElement('div');
  cell.className = 'calendar-day';
  if (isOtherMonth) cell.classList.add('other-month');
  if (isToday) cell.classList.add('today');
  
  const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
  
  // Find events for this day
  const dayEvents = allEvents.filter(event => {
    const eventStart = event.start.split('T')[0];
    const eventEnd = event.end.split('T')[0];
    // Match if date equals event date (for daily events) OR falls within event range (for old format)
    return dateStr === eventStart || (dateStr >= eventStart && dateStr <= eventEnd);
  });
  
  if (dayEvents.length > 0) {
    cell.classList.add('has-events');
  }
  
  cell.innerHTML = `
    <div class="day-number">${day}</div>
    <div class="day-events">
      ${dayEvents.slice(0, 3).map(event => `
        <div class="calendar-event event-${event.extendedProps.status.toLowerCase().replace(' ', '-')}" 
             onclick="showEventModal(${event.id})" 
             title="${event.title} - ${event.extendedProps.status}">
          ${event.title}
        </div>
      `).join('')}
      ${dayEvents.length > 3 ? `<div style="font-size: 0.7rem; color: #64748b; text-align: center;">+${dayEvents.length - 3} more</div>` : ''}
    </div>
  `;
  
  return cell;
}

function renderListView() {
  const listView = document.getElementById('calendarListView');
  
  if (allEvents.length === 0) {
    listView.innerHTML = '<p style="text-align: center; color: #64748b; padding: 2rem;">No contracts scheduled for this period.</p>';
    return;
  }
  
  // Sort events by start date
  const sortedEvents = [...allEvents].sort((a, b) => new Date(a.start) - new Date(b.start));
  
  listView.innerHTML = sortedEvents.map(event => `
    <div class="list-event-item" onclick="showEventModal(${event.id})">
      <div class="list-event-header">
        <div class="list-event-title">${event.title}</div>
        <div class="list-event-status" style="background: ${event.backgroundColor};">
          ${event.extendedProps.status}
        </div>
      </div>
      <div class="list-event-details">
        <div class="list-event-detail">
          <i class="bi bi-calendar"></i>
          <span>${formatDate(event.start)} - ${formatDate(event.end)}</span>
        </div>
        <div class="list-event-detail">
          <i class="bi bi-clock"></i>
          <span>${formatTime(event.start)} - ${formatTime(event.end)}</span>
        </div>
        <div class="list-event-detail">
          <i class="bi bi-person"></i>
          <span>${event.extendedProps.client}</span>
        </div>
        <div class="list-event-detail">
          <i class="bi bi-currency-dollar"></i>
          <span>₱${event.extendedProps.rate}</span>
        </div>
      </div>
    </div>
  `).join('');
}

function showEventModal(contractId) {
  const event = allEvents.find(e => e.id === contractId);
  if (!event) return;
  
  document.getElementById('modalTitle').textContent = event.title;
  document.getElementById('modalBody').innerHTML = `
    <div class="event-detail-row">
      <div class="event-detail-label">Status</div>
      <div class="event-detail-value">
        <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 12px; background: ${event.backgroundColor}; color: white; font-size: 0.875rem;">
          ${event.extendedProps.status}
        </span>
      </div>
    </div>
    <div class="event-detail-row">
      <div class="event-detail-label">Client</div>
      <div class="event-detail-value">${event.extendedProps.client}</div>
    </div>
    <div class="event-detail-row">
      <div class="event-detail-label">Date Range</div>
      <div class="event-detail-value">${formatDate(event.start)} to ${formatDate(event.end)}</div>
    </div>
    <div class="event-detail-row">
      <div class="event-detail-label">Work Hours</div>
      <div class="event-detail-value">${formatTime(event.start)} - ${formatTime(event.end)}</div>
    </div>
    <div class="event-detail-row">
      <div class="event-detail-label">Rate</div>
      <div class="event-detail-value">₱${event.extendedProps.rate}</div>
    </div>
    ${event.extendedProps.description ? `
      <div class="event-detail-row">
        <div class="event-detail-label">Description</div>
        <div class="event-detail-value">${event.extendedProps.description}</div>
      </div>
    ` : ''}
  `;
  
  document.getElementById('modalViewBtn').href = `/jobs/contract/${contractId}/`;
  document.getElementById('eventModal').classList.add('active');
}

function closeEventModal(event) {
  if (!event || event.target.id === 'eventModal') {
    document.getElementById('eventModal').classList.remove('active');
  }
}

function switchView(view) {
  currentView = view;
  
  // Update button states
  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.view === view) {
      btn.classList.add('active');
    }
  });
  
  // Toggle views
  if (view === 'month') {
    document.getElementById('calendarGrid').classList.remove('hidden');
    document.getElementById('calendarListView').classList.remove('active');
    renderMonthView();
  } else {
    document.getElementById('calendarGrid').classList.add('hidden');
    document.getElementById('calendarListView').classList.add('active');
    renderListView();
  }
}

function previousMonth() {
  currentDate.setMonth(currentDate.getMonth() - 1);
  loadCalendarEvents();
}

function nextMonth() {
  currentDate.setMonth(currentDate.getMonth() + 1);
  loadCalendarEvents();
}

function goToToday() {
  currentDate = new Date();
  loadCalendarEvents();
}

function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function formatTime(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
}
</script>
