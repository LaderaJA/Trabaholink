{% extends 'mainpages/base.html' %}
{% load static %}
{% load i18n %}

{% block css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
/* ===== TRABAHOLINK THEME VARIABLES ===== */
:root {
  --trabaholink-cyan: #AFE4E6;
  --trabaholink-blue: #5271FF;
  --trabaholink-dark-blue: #004AAD;
  --trabaholink-light-blue: #84C7EE;
  --success-color: #10b981;
  --warning-color: #f59e0b;
  --danger-color: #ef4444;
  --text-dark: #1a202c;
  --text-medium: #4a5568;
  --text-light: #718096;
  --bg-light: #f7fafc;
  --bg-white: #ffffff;
  --border-color: #e2e8f0;
  --gradient-primary: linear-gradient(135deg, var(--trabaholink-blue) 0%, var(--trabaholink-dark-blue) 100%);
  --gradient-accent: linear-gradient(135deg, var(--trabaholink-cyan) 0%, var(--trabaholink-light-blue) 100%);
  --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
}

/* Global Styles */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg-light);
}

/* Page Wrapper */
.job-form-wrapper {
  min-height: 100vh;
  padding: 2rem 0 4rem;
  background: linear-gradient(180deg, #f0f9ff 0%, var(--bg-light) 100%);
}

/* Header Section with Trabaholink Branding */
.form-header-section {
  background: var(--gradient-primary);
  color: white;
  padding: 3rem 0;
  margin-bottom: 2.5rem;
  position: relative;
  overflow: hidden;
  border-radius: 0 0 24px 24px;
  box-shadow: var(--shadow-xl);
}

.form-header-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  opacity: 0.3;
}

.form-header-content {
  position: relative;
  z-index: 2;
  text-align: center;
}

.form-header-title {
  font-size: 2.5rem;
  font-weight: 700;
  margin: 0 0 0.75rem 0;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1rem;
}

.form-header-subtitle {
  font-size: 1.125rem;
  opacity: 0.95;
  margin: 0;
}

/* Step Progress Indicator */
.step-progress-container {
  background: white;
  border-radius: 16px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-md);
}

.step-progress {
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
  max-width: 800px;
  margin: 0 auto;
}

.step-progress::before {
  content: '';
  position: absolute;
  top: 24px;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--border-color);
  z-index: 0;
}

.step-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  position: relative;
  z-index: 1;
  flex: 1;
  cursor: pointer;
  transition: all 0.3s ease;
}

.step-circle {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: white;
  border: 3px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 1.125rem;
  color: var(--text-light);
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.step-item.active .step-circle {
  background: var(--gradient-primary);
  border-color: var(--trabaholink-blue);
  color: white;
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(82, 113, 255, 0.3);
}

.step-item.completed .step-circle {
  background: var(--success-color);
  border-color: var(--success-color);
  color: white;
}

.step-label {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--text-medium);
  text-align: center;
  white-space: nowrap;
}

.step-item.active .step-label {
  color: var(--trabaholink-blue);
  font-weight: 700;
}

/* Main Form Container */
.form-main-container {
  max-width: 1200px;
  margin: 0 auto;
}

.form-card {
  background: white;
  border-radius: 20px;
  box-shadow: var(--shadow-xl);
  overflow: hidden;
  margin-bottom: 2rem;
}

/* Form Step Sections */
.form-step {
  display: none;
  padding: 3rem;
  animation: fadeInUp 0.5s ease;
}

.form-step.active {
  display: block;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.step-section-title {
  font-size: 1.75rem;
  font-weight: 700;
  color: var(--text-dark);
  margin: 0 0 0.5rem 0;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.step-section-title i {
  color: var(--trabaholink-blue);
}

.step-section-description {
  color: var(--text-medium);
  margin: 0 0 2rem 0;
  font-size: 1.05rem;
}

/* Form Groups */
.form-group {
  margin-bottom: 1.75rem;
}

.form-label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 600;
  color: var(--text-dark);
  margin-bottom: 0.625rem;
  font-size: 0.95rem;
}

.form-label i {
  color: var(--trabaholink-blue);
  font-size: 1.1rem;
}

.form-label .required {
  color: var(--danger-color);
  margin-left: 0.25rem;
}

.form-control {
  width: 100%;
  padding: 0.875rem 1.125rem;
  border: 2px solid var(--border-color);
  border-radius: 12px;
  font-size: 1rem;
  transition: all 0.3s ease;
  background: var(--bg-white);
  font-family: inherit;
}

.form-control:focus {
  outline: none;
  border-color: var(--trabaholink-blue);
  background: white;
  box-shadow: 0 0 0 4px rgba(82, 113, 255, 0.1);
}

.form-control:hover {
  border-color: var(--trabaholink-light-blue);
}

textarea.form-control {
  min-height: 120px;
  resize: vertical;
}

select.form-control {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%234a5568' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 1rem center;
  padding-right: 2.5rem;
}

/* Form Row for Multiple Columns */
.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.25rem;
  margin-bottom: 1.75rem;
}

/* Help Text */
.help-text {
  font-size: 0.875rem;
  color: var(--text-light);
  margin-top: 0.5rem;
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
}

.help-text i {
  color: var(--trabaholink-cyan);
  margin-top: 0.125rem;
  flex-shrink: 0;
}

/* Error Messages */
.error-message {
  color: var(--danger-color);
  font-size: 0.875rem;
  margin-top: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.625rem 0.875rem;
  background: #fee2e2;
  border-radius: 8px;
  border-left: 3px solid var(--danger-color);
}

/* Checkbox and Radio Styles */
input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: var(--trabaholink-blue);
}

/* Image Upload Section */
.image-upload-container {
  margin-top: 1rem;
}

.image-upload-zone {
  border: 3px dashed var(--border-color);
  border-radius: 16px;
  padding: 3rem 2rem;
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;
  background: linear-gradient(135deg, #f0f9ff 0%, white 100%);
}

.image-upload-zone:hover {
  border-color: var(--trabaholink-blue);
  background: linear-gradient(135deg, var(--trabaholink-cyan) 0%, white 100%);
  transform: translateY(-2px);
}

.upload-icon {
  font-size: 3.5rem;
  color: var(--trabaholink-blue);
  margin-bottom: 1rem;
  display: block;
}

.upload-text {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--text-dark);
  margin-bottom: 0.5rem;
}

.upload-hint {
  font-size: 0.875rem;
  color: var(--text-light);
}

/* Image Preview Grid */
.image-preview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 1.25rem;
  margin-top: 1.5rem;
}

.preview-item {
  position: relative;
  border-radius: 12px;
  overflow: hidden;
  aspect-ratio: 1;
  border: 2px solid var(--border-color);
  box-shadow: var(--shadow-sm);
  transition: all 0.3s ease;
}

.preview-item:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
}

.preview-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.preview-delete-btn {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  background: var(--danger-color);
  color: white;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.preview-delete-btn:hover {
  transform: scale(1.15);
  background: #dc2626;
}

/* Map Section */
.map-container {
  margin-top: 1.5rem;
}

#map {
  height: 400px;
  border-radius: 16px;
  border: 2px solid var(--border-color);
  box-shadow: var(--shadow-md);
  overflow: hidden;
}

.map-info-bar {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
  padding: 1.25rem;
  background: linear-gradient(135deg, var(--trabaholink-cyan) 0%, var(--trabaholink-light-blue) 100%);
  border-radius: 12px;
}

.map-info-item {
  text-align: center;
}

.map-info-label {
  font-size: 0.875rem;
  color: var(--trabaholink-dark-blue);
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.map-info-value {
  font-size: 1.125rem;
  color: var(--text-dark);
  font-weight: 700;
}

/* Navigation Buttons */
.form-navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 2rem 3rem;
  background: var(--bg-light);
  border-top: 2px solid var(--border-color);
  gap: 1rem;
}

.btn {
  padding: 0.875rem 2rem;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.625rem;
  border: none;
  text-decoration: none;
}

.btn-secondary {
  background: white;
  color: var(--text-medium);
  border: 2px solid var(--border-color);
}

.btn-secondary:hover {
  background: var(--bg-light);
  border-color: var(--text-medium);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.btn-primary {
  background: var(--gradient-primary);
  color: white;
  box-shadow: 0 4px 15px rgba(82, 113, 255, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(82, 113, 255, 0.4);
}

.btn-success {
  background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
  color: white;
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

/* Sidebar Guidelines */
.guidelines-sidebar {
  position: sticky;
  top: 100px;
  background: white;
  border-radius: 16px;
  padding: 2rem;
  box-shadow: var(--shadow-lg);
  border: 2px solid var(--trabaholink-cyan);
}

.guidelines-title {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text-dark);
  margin: 0 0 1.25rem 0;
  display: flex;
  align-items: center;
  gap: 0.625rem;
}

.guidelines-title i {
  color: var(--trabaholink-blue);
  font-size: 1.5rem;
}

.guideline-item {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  padding: 0.875rem 0;
  border-bottom: 1px solid var(--border-color);
  font-size: 0.9rem;
  color: var(--text-medium);
}

.guideline-item:last-child {
  border-bottom: none;
}

.guideline-item i {
  color: var(--success-color);
  margin-top: 0.125rem;
  flex-shrink: 0;
  font-size: 1.125rem;
}

/* Unsaved Changes Warning */
.unsaved-warning {
  display: none;
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  background: var(--warning-color);
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 12px;
  box-shadow: var(--shadow-xl);
  z-index: 1000;
  animation: slideInUp 0.3s ease;
}

@keyframes slideInUp {
  from {
    transform: translateY(100px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* Responsive Design */
@media (max-width: 768px) {
  .form-header-title {
    font-size: 1.75rem;
    flex-direction: column;
  }
  
  .step-progress {
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  .step-item {
    flex: 0 0 calc(50% - 0.5rem);
  }
  
  .step-label {
    font-size: 0.75rem;
  }
  
  .form-step {
    padding: 1.5rem;
  }
  
  .form-navigation {
    padding: 1.5rem;
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
    justify-content: center;
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 576px) {
  .job-form-wrapper {
    padding: 1rem 0 2rem;
  }
  
  .form-header-section {
    padding: 2rem 0;
  }
  
  .step-progress-container {
    padding: 1rem;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="job-form-wrapper">
  <!-- Header Section -->
  <div class="form-header-section">
    <div class="container">
      <div class="form-header-content">
        <h1 class="form-header-title">
          <i class="bi bi-briefcase-fill"></i>
          {% if object %}Edit Job Posting{% else %}Post a New Job{% endif %}
        </h1>
        <p class="form-header-subtitle">
          {% if object %}Update your job details to attract the right workers{% else %}Connect with skilled workers in your area{% endif %}
        </p>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Step Progress Indicator -->
    <div class="step-progress-container">
      <div class="step-progress">
        <div class="step-item active" data-step="1">
          <div class="step-circle">1</div>
          <span class="step-label">Job Details</span>
        </div>
        <div class="step-item" data-step="2">
          <div class="step-circle">2</div>
          <span class="step-label">Location</span>
        </div>
        <div class="step-item" data-step="3">
          <div class="step-circle">3</div>
          <span class="step-label">Requirements</span>
        </div>
        <div class="step-item" data-step="4">
          <div class="step-circle">4</div>
          <span class="step-label">Media</span>
        </div>
        <div class="step-item" data-step="5">
          <div class="step-circle">5</div>
          <span class="step-label">Review</span>
        </div>
      </div>
    </div>

    <!-- Main Form -->
    <form method="post" enctype="multipart/form-data" id="jobForm" novalidate>
      {% csrf_token %}
      
      <!-- Display Messages -->
      {% if messages %}
      <div style="margin-bottom: 2rem;">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" style="padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem; {% if message.tags == 'error' or message.tags == 'danger' %}background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5;{% elif message.tags == 'success' %}background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7;{% elif message.tags == 'warning' %}background: #fef3c7; color: #92400e; border: 1px solid #fcd34d;{% else %}background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd;{% endif %}">
          <strong>
            {% if message.tags == 'error' or message.tags == 'danger' %}
              <i class="bi bi-exclamation-triangle-fill"></i> Error:
            {% elif message.tags == 'success' %}
              <i class="bi bi-check-circle-fill"></i> Success:
            {% elif message.tags == 'warning' %}
              <i class="bi bi-exclamation-circle-fill"></i> Warning:
            {% else %}
              <i class="bi bi-info-circle-fill"></i> Info:
            {% endif %}
          </strong>
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" style="float: right;"></button>
        </div>
        {% endfor %}
      </div>
      {% endif %}
      
      <!-- Display Form Errors -->
      {% if form.errors %}
      <div class="alert alert-danger" style="padding: 1rem; margin-bottom: 2rem; border-radius: 0.5rem; background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5;">
        <strong><i class="bi bi-exclamation-triangle-fill"></i> Please correct the following errors:</strong>
        <ul style="margin: 0.5rem 0 0 1.5rem;">
          {% for field, errors in form.errors.items %}
            {% for error in errors %}
              <li><strong>{{ field }}:</strong> {{ error }}</li>
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      
      <div class="form-card">
        <!-- Step 1: Job Details -->
        <div class="form-step active" data-step="1">
          <h2 class="step-section-title">
            <i class="bi bi-briefcase"></i>
            Job Details
          </h2>
          <p class="step-section-description">
            Provide basic information about the job you're posting
          </p>

          <div class="form-group">
            <label for="{{ form.title.id_for_label }}" class="form-label">
              <i class="bi bi-card-heading"></i>
              Job Title
              <span class="required">*</span>
            </label>
            {{ form.title }}
            {% if form.title.errors %}
              <div class="error-message">
                <i class="bi bi-exclamation-circle"></i>
                {{ form.title.errors.0 }}
              </div>
            {% endif %}
            <div class="help-text">
              <i class="bi bi-info-circle"></i>
              <span>Be specific and clear. Example: "Plumber Needed for Bathroom Renovation"</span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="{{ form.category.id_for_label }}" class="form-label">
                <i class="bi bi-tag"></i>
                Category
                <span class="required">*</span>
              </label>
              {{ form.category }}
              {% if form.category.errors %}
                <div class="error-message">
                  <i class="bi bi-exclamation-circle"></i>
                  {{ form.category.errors.0 }}
                </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.budget.id_for_label }}" class="form-label">
                <i class="bi bi-cash-stack"></i>
                Budget (₱)
                <span class="required">*</span>
              </label>
              {{ form.budget }}
              {% if form.budget.errors %}
                <div class="error-message">
                  <i class="bi bi-exclamation-circle"></i>
                  {{ form.budget.errors.0 }}
                </div>
              {% endif %}
              <div class="help-text">
                <i class="bi bi-info-circle"></i>
                <span>Set a fair budget to attract quality workers</span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="{{ form.description.id_for_label }}" class="form-label">
              <i class="bi bi-file-text"></i>
              Job Description
              <span class="required">*</span>
            </label>
            {{ form.description }}
            {% if form.description.errors %}
              <div class="error-message">
                <i class="bi bi-exclamation-circle"></i>
                {{ form.description.errors.0 }}
              </div>
            {% endif %}
            <div class="help-text">
              <i class="bi bi-info-circle"></i>
              <span>Describe the job in detail. Include what needs to be done and any important information.</span>
            </div>
          </div>

          <div class="form-group">
            <label for="{{ form.tasks.id_for_label }}" class="form-label">
              <i class="bi bi-list-task"></i>
              Specific Tasks
            </label>
            {{ form.tasks }}
            {% if form.tasks.errors %}
              <div class="error-message">
                <i class="bi bi-exclamation-circle"></i>
                {{ form.tasks.errors.0 }}
              </div>
            {% endif %}
            <div class="help-text">
              <i class="bi bi-info-circle"></i>
              <span>List specific tasks the worker will perform</span>
            </div>
          </div>
        </div>

        <!-- Step 2: Location -->
        <div class="form-step" data-step="2">
          <h2 class="step-section-title">
            <i class="bi bi-geo-alt"></i>
            Location Information
          </h2>
          <p class="step-section-description">
            Specify where the job will take place
          </p>

          <div class="form-row">
            <div class="form-group">
              <label for="{{ form.municipality.id_for_label }}" class="form-label">
                <i class="bi bi-building"></i>
                Municipality
                <span class="required">*</span>
              </label>
              {{ form.municipality }}
              {% if form.municipality.errors %}
                <div class="error-message">
                  <i class="bi bi-exclamation-circle"></i>
                  {{ form.municipality.errors.0 }}
                </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.barangay.id_for_label }}" class="form-label">
                <i class="bi bi-map"></i>
                Barangay
                <span class="required">*</span>
              </label>
              {{ form.barangay }}
              {% if form.barangay.errors %}
                <div class="error-message">
                  <i class="bi bi-exclamation-circle"></i>
                  {{ form.barangay.errors.0 }}
                </div>
              {% endif %}
              <div class="help-text">
                <i class="bi bi-info-circle"></i>
                <span>The local administrative division within the municipality</span>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="{{ form.subdivision.id_for_label }}" class="form-label">
                <i class="bi bi-houses"></i>
                Subdivision 
              </label>
              {{ form.subdivision }}
              {% if form.subdivision.errors %}
                <div class="error-message">
                  <i class="bi bi-exclamation-circle"></i>
                  {{ form.subdivision.errors.0 }}
                </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.street.id_for_label }}" class="form-label">
                <i class="bi bi-signpost"></i>
                Street/Block/Lot Number
              </label>
              {{ form.street }}
              {% if form.street.errors %}
                <div class="error-message">
                  <i class="bi bi-exclamation-circle"></i>
                  {{ form.street.errors.0 }}
                </div>
              {% endif %}
            </div>
          </div>

          <div class="form-group">
            <label for="{{ form.house_number.id_for_label }}" class="form-label">
              <i class="bi bi-house"></i>
              House/Building Number (Optional)
            </label>
            {{ form.house_number }}
            {% if form.house_number.errors %}
              <div class="error-message">
                <i class="bi bi-exclamation-circle"></i>
                {{ form.house_number.errors.0 }}
              </div>
            {% endif %}
          </div>

          <div class="map-container">
            <label class="form-label">
              <i class="bi bi-pin-map"></i>
              Pin Job Location on Map
              <span class="required">*</span>
            </label>
            <div class="help-text" style="margin-bottom: 1rem;">
              <i class="bi bi-info-circle"></i>
              <span>Click on the map or drag the marker to set the exact location</span>
            </div>
            <div id="map"></div>
            <input type="hidden" id="latitude" name="latitude" value="{{ object.latitude|default:'14.4310956' }}">
            <input type="hidden" id="longitude" name="longitude" value="{{ object.longitude|default:'120.968096097231' }}">
            
            <div class="map-info-bar">
              <div class="map-info-item">
                <div class="map-info-label">Latitude</div>
                <div class="map-info-value" id="lat-display">{{ object.latitude|default:'Not set' }}</div>
              </div>
              <div class="map-info-item">
                <div class="map-info-label">Longitude</div>
                <div class="map-info-value" id="lon-display">{{ object.longitude|default:'Not set' }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Requirements & Details -->
        <div class="form-step" data-step="3">
          <h2 class="step-section-title">
            <i class="bi bi-list-check"></i>
            Job Requirements & Details
          </h2>
          <p class="step-section-description">
            Specify requirements, schedule, and payment details
          </p>

          <div class="form-row">
            <div class="form-group">
              <label for="{{ form.duration.id_for_label }}" class="form-label">
                <i class="bi bi-hourglass"></i>
                Duration
              </label>
              {{ form.duration }}
              {% if form.duration.errors %}
                <div class="error-message">
                  <i class="bi bi-exclamation-circle"></i>
                  {{ form.duration.errors.0 }}
                </div>
              {% endif %}
              <div class="help-text">
                <i class="bi bi-info-circle"></i>
                <span>Example: "2 days", "1 week", "3 hours"</span>
              </div>
            </div>

            <div class="form-group">
              <label for="{{ form.schedule.id_for_label }}" class="form-label">
                <i class="bi bi-calendar-week"></i>
                Schedule
              </label>
              {{ form.schedule }}
              {% if form.schedule.errors %}
                <div class="error-message">
                  <i class="bi bi-exclamation-circle"></i>
                  {{ form.schedule.errors.0 }}
                </div>
              {% endif %}
              <div class="help-text">
                <i class="bi bi-info-circle"></i>
                <span>Example: "Monday-Friday, 9AM-5PM"</span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="{{ form.start_datetime.id_for_label }}" class="form-label">
              <i class="bi bi-calendar-event"></i>
              Start Date & Time
            </label>
            {{ form.start_datetime }}
            {% if form.start_datetime.errors %}
              <div class="error-message">
                <i class="bi bi-exclamation-circle"></i>
                {{ form.start_datetime.errors.0 }}
              </div>
            {% endif %}
          </div>

          <div class="form-group">
            <label for="{{ form.required_skills.id_for_label }}" class="form-label">
              <i class="bi bi-star"></i>
              Required Skills
            </label>
            {{ form.required_skills }}
            {% if form.required_skills.errors %}
              <div class="error-message">
                <i class="bi bi-exclamation-circle"></i>
                {{ form.required_skills.errors.0 }}
              </div>
            {% endif %}
            <div class="help-text">
              <i class="bi bi-info-circle"></i>
              <span>List skills or experience needed for this job</span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="{{ form.tools_provided.id_for_label }}" class="form-label">
                <i class="bi bi-tools"></i>
                Tools Provided?
              </label>
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                {{ form.tools_provided }}
                <span style="color: var(--text-medium);">Check if you will provide tools</span>
              </div>
              {% if form.tools_provided.errors %}
                <div class="error-message">
                  <i class="bi bi-exclamation-circle"></i>
                  {{ form.tools_provided.errors.0 }}
                </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.materials_provided.id_for_label }}" class="form-label">
                <i class="bi bi-box-seam"></i>
                Materials Provided?
              </label>
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                {{ form.materials_provided }}
                <span style="color: var(--text-medium);">Check if you will provide materials</span>
              </div>
              {% if form.materials_provided.errors %}
                <div class="error-message">
                  <i class="bi bi-exclamation-circle"></i>
                  {{ form.materials_provided.errors.0 }}
                </div>
              {% endif %}
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="{{ form.payment_method.id_for_label }}" class="form-label">
                <i class="bi bi-credit-card"></i>
                Payment Method
              </label>
              {{ form.payment_method }}
              {% if form.payment_method.errors %}
                <div class="error-message">
                  <i class="bi bi-exclamation-circle"></i>
                  {{ form.payment_method.errors.0 }}
                </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.payment_schedule.id_for_label }}" class="form-label">
                <i class="bi bi-calendar-check"></i>
                Payment Schedule
              </label>
              {{ form.payment_schedule }}
              {% if form.payment_schedule.errors %}
                <div class="error-message">
                  <i class="bi bi-exclamation-circle"></i>
                  {{ form.payment_schedule.errors.0 }}
                </div>
              {% endif %}
              <div class="help-text">
                <i class="bi bi-info-circle"></i>
                <span>Example: "Upon completion", "50% upfront, 50% after"</span>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="{{ form.urgency.id_for_label }}" class="form-label">
                <i class="bi bi-exclamation-triangle"></i>
                Urgency
              </label>
              {{ form.urgency }}
              {% if form.urgency.errors %}
                <div class="error-message">
                  <i class="bi bi-exclamation-circle"></i>
                  {{ form.urgency.errors.0 }}
                </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.number_of_workers.id_for_label }}" class="form-label">
                <i class="bi bi-people"></i>
                Number of Positions
              </label>
              {{ form.number_of_workers }}
              <small class="form-text text-muted">
                <i class="bi bi-info-circle"></i>
                Total number of workers needed for this job. Available vacancies will automatically update as contracts are finalized.
              </small>
              {% if form.number_of_workers.errors %}
                <div class="error-message">
                  <i class="bi bi-exclamation-circle"></i>
                  {{ form.number_of_workers.errors.0 }}
                </div>
              {% endif %}
            </div>
          </div>

          <div class="form-group">
            <label for="{{ form.posting_duration_days.id_for_label }}" class="form-label">
              <i class="bi bi-clock-history"></i>
              Posting Duration (Days)
            </label>
            {{ form.posting_duration_days }}
            {% if form.posting_duration_days.errors %}
              <div class="error-message">
                <i class="bi bi-exclamation-circle"></i>
                {{ form.posting_duration_days.errors.0 }}
              </div>
            {% endif %}
            <div class="help-text">
              <i class="bi bi-info-circle"></i>
              <span>How many days should this job posting remain active? (Default: 7 days, Max: 90 days)</span>
            </div>
          </div>
        </div>

        <!-- Step 4: Media Upload -->
        <div class="form-step" data-step="4">
          <h2 class="step-section-title">
            <i class="bi bi-images"></i>
            Job Images
          </h2>
          <p class="step-section-description">
            Add images to help workers understand the job better (optional but recommended)
          </p>

          {% if existing_images %}
          <div class="form-group">
            <label class="form-label">
              <i class="bi bi-image"></i>
              Existing Images
            </label>
            <div class="image-preview-grid" id="existing-images">
              {% for image in existing_images %}
              <div class="preview-item" id="image-{{ image.id }}">
                <img src="{{ image.image.url }}" alt="Job Image">
                <button type="button" class="preview-delete-btn" onclick="deleteExistingImage('{{ image.id }}')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <div class="image-upload-container">
            <label class="form-label">
              <i class="bi bi-cloud-upload"></i>
              Upload New Images
            </label>
            <div class="help-text" style="margin-bottom: 1rem;">
              <i class="bi bi-info-circle"></i>
              <span>Add photos of the work area, materials, or examples of what you need done</span>
            </div>
            <label for="{{ image_form.images.id_for_label }}" class="image-upload-zone">
              <i class="bi bi-cloud-arrow-up upload-icon"></i>
              <div class="upload-text">Click to upload or drag and drop</div>
              <div class="upload-hint">PNG, JPG up to 10MB each • Multiple files supported</div>
              <input type="file" id="{{ image_form.images.id_for_label }}" name="{{ image_form.images.name }}" multiple accept="image/*" style="display: none;">
            </label>
            <div id="new-image-previews" class="image-preview-grid"></div>
          </div>
        </div>

        <!-- Step 5: Review -->
        <div class="form-step" data-step="5">
          <h2 class="step-section-title">
            <i class="bi bi-check-circle"></i>
            Review Your Job Posting
          </h2>
          <p class="step-section-description">
            Please review all the information before submitting
          </p>

          <div style="background: linear-gradient(135deg, #f0f9ff 0%, white 100%); border-radius: 16px; padding: 2rem; border: 2px solid var(--trabaholink-cyan);">
            <div style="display: grid; gap: 1.5rem;">
              <div>
                <h3 style="color: var(--trabaholink-dark-blue); font-size: 1.125rem; margin: 0 0 0.5rem 0;">
                  <i class="bi bi-briefcase" style="margin-right: 0.5rem;"></i>Job Details
                </h3>
                <div id="review-job-details" style="color: var(--text-medium); line-height: 1.8;"></div>
              </div>
              
              <div>
                <h3 style="color: var(--trabaholink-dark-blue); font-size: 1.125rem; margin: 0 0 0.5rem 0;">
                  <i class="bi bi-geo-alt" style="margin-right: 0.5rem;"></i>Location
                </h3>
                <div id="review-location" style="color: var(--text-medium); line-height: 1.8;"></div>
              </div>
              
              <div>
                <h3 style="color: var(--trabaholink-dark-blue); font-size: 1.125rem; margin: 0 0 0.5rem 0;">
                  <i class="bi bi-list-check" style="margin-right: 0.5rem;"></i>Requirements
                </h3>
                <div id="review-requirements" style="color: var(--text-medium); line-height: 1.8;"></div>
              </div>

              <div>
                <h3 style="color: var(--trabaholink-dark-blue); font-size: 1.125rem; margin: 0 0 0.5rem 0;">
                  <i class="bi bi-images" style="margin-right: 0.5rem;"></i>Images
                </h3>
                <div id="review-images" style="color: var(--text-medium);"></div>
              </div>
            </div>
          </div>

          <div style="margin-top: 2rem; padding: 1.25rem; background: #fef3c7; border-radius: 12px; border-left: 4px solid var(--warning-color);">
            <p style="margin: 0; color: var(--text-dark); display: flex; align-items: flex-start; gap: 0.75rem;">
              <i class="bi bi-info-circle" style="color: var(--warning-color); font-size: 1.25rem; margin-top: 0.125rem;"></i>
              <span>By submitting this job posting, you agree to Trabaholink's terms of service. Make sure all information is accurate and complete.</span>
            </p>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="form-navigation">
          <button type="button" class="btn btn-secondary" id="prevBtn" onclick="changeStep(-1)">
            <i class="bi bi-arrow-left"></i>
            Previous
          </button>
          <div style="flex: 1;"></div>
          <button type="button" class="btn btn-primary" id="nextBtn" onclick="changeStep(1)">{% trans "Next" %}<i class="bi bi-arrow-right"></i>
          </button>
          <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
            <i class="bi bi-check-circle"></i>
            {% if object %}Update Job Posting{% else %}Post Job{% endif %}
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Unsaved Changes Warning -->
<div class="unsaved-warning" id="unsavedWarning">
  <i class="bi bi-exclamation-triangle" style="margin-right: 0.5rem;"></i>
  You have unsaved changes
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Global variables
let currentStep = 1;
const totalSteps = 5;
let formChanged = false;
let map, marker;

document.addEventListener('DOMContentLoaded', function() {
  // Apply form control classes
  const formControls = document.querySelectorAll('input[type="text"], input[type="number"], input[type="email"], input[type="datetime-local"], select, textarea');
  formControls.forEach(control => {
    if (!control.classList.contains('form-control')) {
      control.classList.add('form-control');
    }
  });

  // Track form changes
  const form = document.getElementById('jobForm');
  form.addEventListener('change', function() {
    formChanged = true;
    document.getElementById('unsavedWarning').style.display = 'block';
  });

  // Warn before leaving with unsaved changes
  window.addEventListener('beforeunload', function(e) {
    if (formChanged) {
      e.preventDefault();
      e.returnValue = '';
      return '';
    }
  });

  // Form submission - remove warning and log data
  form.addEventListener('submit', function(e) {
    console.log('=== JOB FORM SUBMISSION STARTED ===');
    console.log('Latitude:', document.getElementById('latitude').value);
    console.log('Longitude:', document.getElementById('longitude').value);
    
    // Check if lat/lng are set
    const lat = document.getElementById('latitude').value;
    const lng = document.getElementById('longitude').value;
    
    if (!lat || !lng) {
      e.preventDefault();
      alert('Location is required. Please set a location on the map.');
      console.log('BLOCKED: No location set');
      return false;
    }
    
    // Log all form data
    const formData = new FormData(this);
    console.log('=== FORM DATA ===');
    for (let [key, value] of formData.entries()) {
      if (value instanceof File) {
        console.log(key + ':', value.name);
      } else {
        console.log(key + ':', value);
      }
    }
    console.log('=== FORM WILL SUBMIT ===');
    
    formChanged = false;
    document.getElementById('unsavedWarning').style.display = 'none';
    return true;
  });

  // Initialize map
  initializeMap();
  
  // Setup location sync between inputs and map
  setupLocationSync();

  // Image preview
  setupImagePreview();

  // Show first step
  showStep(currentStep);
});

function showStep(step) {
  const steps = document.querySelectorAll('.form-step');
  const stepItems = document.querySelectorAll('.step-item');
  
  // Hide all steps
  steps.forEach(s => s.classList.remove('active'));
  
  // Show current step
  const currentStepEl = document.querySelector(`.form-step[data-step="${step}"]`);
  if (currentStepEl) {
    currentStepEl.classList.add('active');
  }
  
  // Update step indicators
  stepItems.forEach((item, index) => {
    const stepNum = index + 1;
    item.classList.remove('active', 'completed');
    
    if (stepNum < step) {
      item.classList.add('completed');
      item.querySelector('.step-circle').innerHTML = '<i class="bi bi-check"></i>';
    } else if (stepNum === step) {
      item.classList.add('active');
      item.querySelector('.step-circle').textContent = stepNum;
    } else {
      item.querySelector('.step-circle').textContent = stepNum;
    }
  });
  
  // Update buttons
  document.getElementById('prevBtn').style.display = step === 1 ? 'none' : 'inline-flex';
  document.getElementById('nextBtn').style.display = step === totalSteps ? 'none' : 'inline-flex';
  document.getElementById('submitBtn').style.display = step === totalSteps ? 'inline-flex' : 'none';
  
  // If on review step, populate review
  if (step === 5) {
    populateReview();
  }
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function changeStep(direction) {
  // Validate current step before moving forward
  if (direction === 1 && !validateStep(currentStep)) {
    return;
  }
  
  const newStep = currentStep + direction;
  if (newStep >= 1 && newStep <= totalSteps) {
    currentStep = newStep;
    showStep(currentStep);
  }
}

function validateStep(step) {
  const currentStepEl = document.querySelector(`.form-step[data-step="${step}"]`);
  if (!currentStepEl) return true;
  
  const requiredFields = currentStepEl.querySelectorAll('[required]');
  let isValid = true;
  
  requiredFields.forEach(field => {
    if (!field.value.trim()) {
      isValid = false;
      field.style.borderColor = 'var(--danger-color)';
      
      // Show error message
      let errorDiv = field.parentElement.querySelector('.error-message');
      if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.innerHTML = '<i class="bi bi-exclamation-circle"></i> This field is required';
        field.parentElement.appendChild(errorDiv);
      }
    } else {
      field.style.borderColor = '';
      const errorDiv = field.parentElement.querySelector('.error-message');
      if (errorDiv && !errorDiv.textContent.includes('{{')) {
        errorDiv.remove();
      }
    }
  });
  
  // Special validation for step 2 (location)
  if (step === 2) {
    const lat = document.getElementById('latitude').value;
    const lng = document.getElementById('longitude').value;
    if (!lat || !lng) {
      alert('Please pin the job location on the map');
      isValid = false;
    }
  }
  
  if (!isValid) {
    alert('Please fill in all required fields before proceeding');
  }
  
  return isValid;
}

function populateReview() {
  // Job Details
  const title = document.getElementById('{{ form.title.id_for_label }}').value;
  const category = document.getElementById('{{ form.category.id_for_label }}').selectedOptions[0]?.text || '';
  const budget = document.getElementById('{{ form.budget.id_for_label }}').value;
  const description = document.getElementById('{{ form.description.id_for_label }}').value;
  
  document.getElementById('review-job-details').innerHTML = `
    <p><strong>Title:</strong> ${title || 'Not specified'}</p>
    <p><strong>Category:</strong> ${category || 'Not specified'}</p>
    <p><strong>Budget:</strong> ₱${budget || 'Not specified'}</p>
    <p><strong>Description:</strong> ${description || 'Not specified'}</p>
  `;
  
  // Location
  const municipality = document.getElementById('{{ form.municipality.id_for_label }}').value;
  const barangay = document.getElementById('{{ form.barangay.id_for_label }}').value;
  const street = document.getElementById('{{ form.street.id_for_label }}').value;
  const lat = document.getElementById('latitude').value;
  const lng = document.getElementById('longitude').value;
  
  document.getElementById('review-location').innerHTML = `
    <p><strong>Municipality:</strong> ${municipality || 'Not specified'}</p>
    <p><strong>Barangay:</strong> ${barangay || 'Not specified'}</p>
    ${street ? `<p><strong>Street:</strong> ${street}</p>` : ''}
    <p><strong>Coordinates:</strong> ${lat && lng ? `${parseFloat(lat).toFixed(6)}, ${parseFloat(lng).toFixed(6)}` : 'Not set'}</p>
  `;
  
  // Requirements
  const duration = document.getElementById('{{ form.duration.id_for_label }}').value;
  const schedule = document.getElementById('{{ form.schedule.id_for_label }}').value;
  const workers = document.getElementById('{{ form.number_of_workers.id_for_label }}').value;
  const postingDuration = document.getElementById('{{ form.posting_duration_days.id_for_label }}').value;
  
  document.getElementById('review-requirements').innerHTML = `
    <p><strong>Duration:</strong> ${duration || 'Not specified'}</p>
    <p><strong>Schedule:</strong> ${schedule || 'Not specified'}</p>
    <p><strong>Workers Needed:</strong> ${workers || '1'}</p>
    <p><strong>Posting Duration:</strong> ${postingDuration || '7'} days</p>
  `;
  
  // Images
  const fileInput = document.getElementById('{{ image_form.images.id_for_label }}');
  const imageCount = fileInput.files.length;
  const existingCount = document.querySelectorAll('#existing-images .preview-item').length;
  const totalImages = imageCount + existingCount;
  
  document.getElementById('review-images').innerHTML = `
    <p>${totalImages} image(s) will be uploaded</p>
  `;
}

function initializeMap() {
  // Bacoor, Cavite coordinates
  const bacoorCenter = [14.4167, 120.9833];
  
  // Get saved location or default to Bacoor center
  const defaultLat = parseFloat("{{ object.latitude|default:14.4167|floatformat:7 }}");
  const defaultLon = parseFloat("{{ object.longitude|default:120.9833|floatformat:7 }}");
  
  // Luzon bounds (allow viewing all of Luzon)
  const luzonBounds = [
    [12.0, 119.5],   // Southwest - southern Luzon
    [19.0, 123.0]    // Northeast - northern Luzon
  ];
  
  // Bacoor GeoJSON polygon
  const bacoorGeoJSON = {
    "type": "FeatureCollection",
    "features": [{
      "type": "Feature",
      "properties": {"name": "Bacoor"},
      "geometry": {
        "type": "Polygon",
        "coordinates": [[
          [120.9450, 14.4800], [121.0200, 14.4800], [121.0200, 14.4500],
          [121.0150, 14.4300], [121.0100, 14.4100], [121.0000, 14.3900],
          [120.9900, 14.3850], [120.9700, 14.3850], [120.9550, 14.3900],
          [120.9450, 14.4000], [120.9450, 14.4200], [120.9450, 14.4500],
          [120.9450, 14.4800]
        ]]
      }
    }]
  };
  
  // Create map - can view all of Luzon
  map = L.map('map', {
    center: [defaultLat, defaultLon],
    zoom: 14,
    minZoom: 7,       // Allow zooming out to see all Luzon
    maxZoom: 18,
    maxBounds: luzonBounds,
    maxBoundsViscosity: 0.8
  });
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors',
    maxZoom: 18
  }).addTo(map);
  
  // Create darken mask for outside Bacoor (larger area for Luzon view)
  const maskWorldBounds = [[12.0, 119.5], [19.0, 123.0]];
  const bacoorCoords = bacoorGeoJSON.features[0].geometry.coordinates[0];
  const bacoorLatLngs = bacoorCoords.map(coord => [coord[1], coord[0]]);
  
  // Store Bacoor polygon for point-in-polygon check BEFORE reversing
  window.bacoorPolygon = [...bacoorLatLngs]; // Create a copy
  
  const maskCoordinates = [
    // Outer ring (Luzon rectangle)
    [[maskWorldBounds[0][0], maskWorldBounds[0][1]], 
     [maskWorldBounds[1][0], maskWorldBounds[0][1]],
     [maskWorldBounds[1][0], maskWorldBounds[1][1]], 
     [maskWorldBounds[0][0], maskWorldBounds[1][1]],
     [maskWorldBounds[0][0], maskWorldBounds[0][1]]],
    // Inner ring (Bacoor hole) - reverse for mask
    [...bacoorLatLngs].reverse()
  ];
  
  L.polygon(maskCoordinates, {
    color: 'transparent',
    fillColor: '#000000',
    fillOpacity: 0.5,
    interactive: false
  }).addTo(map);
  
  // Add Bacoor boundary with highlight
  window.bacoorLayer = L.geoJSON(bacoorGeoJSON, {
    style: {
      color: '#10b981',
      weight: 3,
      opacity: 1,
      fillColor: '#10b981',
      fillOpacity: 0.1
    }
  }).addTo(map);
  
  marker = L.marker([defaultLat, defaultLon], {
    draggable: true,
    title: 'Drag to set job location'
  }).addTo(map);
  
  function updateCoordinates(lat, lon) {
    document.getElementById("latitude").value = lat;
    document.getElementById("longitude").value = lon;
    document.getElementById("lat-display").textContent = lat.toFixed(6);
    document.getElementById("lon-display").textContent = lon.toFixed(6);
    formChanged = true;
  }
  
  marker.on('dragend', function() {
    const pos = marker.getLatLng();
    updateCoordinates(pos.lat, pos.lng);
    showLocationWarning(pos.lat, pos.lng);
  });
  
  map.on('click', function(e) {
    marker.setLatLng(e.latlng);
    updateCoordinates(e.latlng.lat, e.latlng.lng);
    showLocationWarning(e.latlng.lat, e.latlng.lng);
  });
  
  updateCoordinates(defaultLat, defaultLon);
  
  // Fix map display when step becomes visible
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.target.classList.contains('active')) {
        setTimeout(() => { 
          map.invalidateSize();
        }, 100);
      }
    });
  });
  
  const step2 = document.querySelector('.form-step[data-step="2"]');
  if (step2) {
    observer.observe(step2, { attributes: true, attributeFilter: ['class'] });
  }
}

function setupImagePreview() {
  const fileInput = document.getElementById("{{ image_form.images.id_for_label }}");
  const previewContainer = document.getElementById("new-image-previews");
  let filesArray = [];
  
  if (fileInput) {
    fileInput.addEventListener("change", function(event) {
      // Convert FileList to Array
      filesArray = Array.from(event.target.files);
      renderPreviews();
      formChanged = true;
    });
  }
  
  function renderPreviews() {
    previewContainer.innerHTML = "";
    
    if (filesArray.length > 0) {
      previewContainer.style.marginTop = "1.5rem";
    } else {
      previewContainer.style.marginTop = "0";
    }
    
    filesArray.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const div = document.createElement("div");
        div.className = "preview-item";
        div.innerHTML = `
          <img src="${e.target.result}" alt="Preview">
          <button type="button" class="preview-delete-btn" onclick="deleteNewImage(${index})">
            <i class="bi bi-trash"></i>
          </button>
        `;
        previewContainer.appendChild(div);
      }
      reader.readAsDataURL(file);
    });
    
    // Update file input with remaining files
    updateFileInput();
  }
  
  function updateFileInput() {
    const dataTransfer = new DataTransfer();
    filesArray.forEach(file => {
      dataTransfer.items.add(file);
    });
    fileInput.files = dataTransfer.files;
  }
  
  // Make deleteNewImage globally accessible
  window.deleteNewImage = function(index) {
    if (confirm('Remove this image?')) {
      filesArray.splice(index, 1);
      renderPreviews();
      formChanged = true;
    }
  };
}

// Check if a point is inside Bacoor polygon
function isPointInBacoor(lat, lng) {
  if (!window.bacoorPolygon) {
    return true; // Default to true if polygon not loaded
  }
  
  const polygon = window.bacoorPolygon;
  let inside = false;
  
  // Ray casting algorithm for point-in-polygon
  // polygon is stored as [lat, lng] pairs
  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const lati = polygon[i][0], lngi = polygon[i][1]; // polygon[i] = [lat, lng]
    const latj = polygon[j][0], lngj = polygon[j][1];
    
    // Check if ray from point crosses this edge
    const intersect = ((lngi > lng) !== (lngj > lng))
      && (lat < (latj - lati) * (lng - lngi) / (lngj - lngi) + lati);
    if (intersect) inside = !inside;
  }
  
  return inside;
}

// Show warning if location is outside Bacoor
function showLocationWarning(lat, lng) {
  // Check if point is in Bacoor
  const inBacoor = isPointInBacoor(lat, lng);
  
  // Always remove existing warning first
  const existingWarning = document.getElementById('bacoor-warning');
  if (existingWarning) {
    existingWarning.remove();
  }
  
  // Always remove existing success message
  const existingSuccess = document.querySelector('[data-location-success]');
  if (existingSuccess) {
    existingSuccess.remove();
  }
  
  if (!inBacoor) {
    // Create warning message
    const warning = document.createElement('div');
    warning.id = 'bacoor-warning';
    warning.style.cssText = `
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #fef3c7;
      border: 2px solid #f59e0b;
      color: #92400e;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideDown 0.3s ease;
    `;
    warning.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
        <line x1="12" y1="9" x2="12" y2="13"></line>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>
      <span>⚠️ Warning: Selected location is outside Bacoor area. Jobs are only available in Bacoor, Cavite.</span>
      <button onclick="this.parentElement.remove()" style="background: none; border: none; cursor: pointer; font-size: 20px; color: #92400e; margin-left: 10px;">×</button>
    `;
    
    // Add slide animation if not already added
    if (!document.getElementById('slideDownAnimation')) {
      const style = document.createElement('style');
      style.id = 'slideDownAnimation';
      style.textContent = '@keyframes slideDown { from { transform: translateX(-50%) translateY(-100%); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }';
      document.head.appendChild(style);
    }
    
    document.body.appendChild(warning);
    
    // Highlight Bacoor boundary
    if (window.bacoorLayer) {
      window.bacoorLayer.setStyle({
        color: '#ef4444',
        weight: 4,
        opacity: 1,
        fillColor: '#ef4444',
        fillOpacity: 0.15
      });
      
      // Pulse effect
      setTimeout(() => {
        window.bacoorLayer.setStyle({
          color: '#10b981',
          weight: 3,
          fillOpacity: 0.1
        });
      }, 2000);
    }
    
    return false;
  } else {
    // Location is in Bacoor - show success briefly
    const success = document.createElement('div');
    success.setAttribute('data-location-success', 'true');
    success.style.cssText = `
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #d1fae5;
      border: 2px solid #10b981;
      color: #065f46;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      font-weight: 600;
      animation: slideDown 0.3s ease;
    `;
    success.textContent = '✅ Location is within Bacoor service area';
    document.body.appendChild(success);
    
    setTimeout(() => success.remove(), 2000);
    return true;
  }
}

function setupLocationSync() {
  // Get all location input elements - using correct Django form IDs
  const streetInput = document.querySelector('[name="street"]');
  const houseNumberInput = document.querySelector('[name="house_number"]');
  const subdivisionInput = document.querySelector('[name="subdivision"]');
  const barangayInput = document.getElementById('{{ form.barangay.id_for_label }}');
  const municipalityInput = document.getElementById('{{ form.municipality.id_for_label }}');
  
  // Function to geocode and update map
  function geocodeAndUpdateMap() {
    const street = streetInput?.value || '';
    const houseNumber = houseNumberInput?.value || '';
    const barangay = barangayInput?.value || '';
    const municipality = 'Bacoor'; // Always Bacoor
    
    // Build full address
    const addressParts = [houseNumber, street, barangay, municipality, 'Cavite', 'Philippines'].filter(p => p);
    const fullAddress = addressParts.join(', ');
    
    if (!fullAddress || fullAddress === 'Bacoor, Cavite, Philippines') {
      return; // Not enough info to geocode
    }
    
    // Use Nominatim geocoding API
    const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1`;
    
    fetch(geocodeUrl)
      .then(response => response.json())
      .then(data => {
        if (data && data.length > 0) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);
          
          // Update map marker and center
          if (marker && map) {
            marker.setLatLng([lat, lon]);
            map.setView([lat, lon], 16);
            
            // Update hidden lat/lon fields
            document.getElementById("latitude").value = lat;
            document.getElementById("longitude").value = lon;
            document.getElementById("lat-display").textContent = lat.toFixed(6);
            document.getElementById("lon-display").textContent = lon.toFixed(6);
          }
        }
      })
      .catch(error => console.error('Geocoding error:', error));
  }
  
  // Function to reverse geocode when marker is dragged
  function reverseGeocode(lat, lon) {
    console.log('Reverse geocoding:', lat, lon);
    const reverseUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
    
    fetch(reverseUrl)
      .then(response => response.json())
      .then(data => {
        console.log('Reverse geocode result:', data);
        if (data && data.address) {
          const addr = data.address;
          console.log('Address object:', addr);
          
          // Update street - try road, street, or highway
          const street = addr.road || addr.street || addr.highway;
          if (street && streetInput) {
            streetInput.value = street;
            console.log('Updated street:', street);
          } else {
            console.log('No street found in response');
          }
          
          // Update house number if available
          if (addr.house_number && houseNumberInput) {
            houseNumberInput.value = addr.house_number;
            console.log('Updated house number:', addr.house_number);
          } else {
            console.log('No house_number in response');
          }
          
          // OpenStreetMap API structure for Bacoor:
          // - suburb = subdivision/neighborhood (e.g., "Molino", "Queens Row")
          // - village = barangay (e.g., "Molino IV", "Queens Row East")
          // - municipality = city (e.g., "Bacoor")
          
          // Update subdivision (smaller area like neighborhood/compound)
          const subdivision = addr.suburb || addr.neighbourhood || addr.quarter;
          console.log('Subdivision from API:', subdivision);
          if (subdivision && subdivisionInput) {
            subdivisionInput.value = subdivision;
            console.log('✅ Updated subdivision field to:', subdivision);
            subdivisionInput.dispatchEvent(new Event('change', { bubbles: true }));
          }
          
          // Update barangay (larger administrative area)
          const barangay = addr.village || addr.hamlet || addr.city_district;
          console.log('Barangay from API:', barangay);
          console.log('Barangay input element:', barangayInput);
          
          if (barangay) {
            if (barangayInput) {
              barangayInput.value = barangay;
              console.log('✅ Updated barangay field to:', barangay);
              barangayInput.dispatchEvent(new Event('change', { bubbles: true }));
            } else {
              console.error('❌ Barangay input element not found!');
            }
          } else {
            console.log('No barangay data in response. Available fields:', Object.keys(addr));
          }
          
          formChanged = true;
        }
      })
      .catch(error => console.error('Reverse geocoding error:', error));
  }
  
  // Add event listeners to location inputs
  let geocodeTimeout;
  const inputs = [streetInput, houseNumberInput, subdivisionInput, barangayInput];
  
  inputs.forEach(input => {
    if (input) {
      input.addEventListener('input', () => {
        clearTimeout(geocodeTimeout);
        geocodeTimeout = setTimeout(geocodeAndUpdateMap, 1000); // Debounce 1 second
      });
    }
  });
  
  // Override marker dragend to also reverse geocode
  if (marker) {
    marker.off('dragend'); // Remove old handler
    marker.on('dragend', function() {
      const pos = marker.getLatLng();
      document.getElementById("latitude").value = pos.lat;
      document.getElementById("longitude").value = pos.lng;
      document.getElementById("lat-display").textContent = pos.lat.toFixed(6);
      document.getElementById("lon-display").textContent = pos.lng.toFixed(6);
      
      // Show location warning
      showLocationWarning(pos.lat, pos.lng);
      
      // Reverse geocode to update address inputs
      reverseGeocode(pos.lat, pos.lng);
      formChanged = true;
    });
  }
  
  // Override map click to also reverse geocode
  if (map) {
    map.off('click'); // Remove old handler
    map.on('click', function(e) {
      marker.setLatLng(e.latlng);
      document.getElementById("latitude").value = e.latlng.lat;
      document.getElementById("longitude").value = e.latlng.lng;
      document.getElementById("lat-display").textContent = e.latlng.lat.toFixed(6);
      document.getElementById("lon-display").textContent = e.latlng.lng.toFixed(6);
      
      // Show location warning
      showLocationWarning(e.latlng.lat, e.latlng.lng);
      
      // Reverse geocode to update address inputs
      reverseGeocode(e.latlng.lat, e.latlng.lng);
      formChanged = true;
    });
  }
}

function deleteExistingImage(imageId) {
  if (confirm('Are you sure you want to delete this image?')) {
    const imageEl = document.getElementById('image-' + imageId);
    if (imageEl) {
      // Add fade-out animation
      imageEl.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      imageEl.style.opacity = '0';
      imageEl.style.transform = 'scale(0.8)';
      
      // Remove from DOM after animation
      setTimeout(() => {
        imageEl.remove();
        
        // Check if there are no more existing images
        const existingImagesContainer = document.getElementById('existing-images');
        if (existingImagesContainer && existingImagesContainer.children.length === 0) {
          existingImagesContainer.parentElement.style.display = 'none';
        }
      }, 300);
      
      // Add hidden input to mark for deletion on server
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'delete_image';
      input.value = imageId;
      document.getElementById('jobForm').appendChild(input);
      
      formChanged = true;
    }
  }
}

// Allow clicking on step indicators to navigate (only to completed steps)
document.querySelectorAll('.step-item').forEach(item => {
  item.addEventListener('click', function() {
    const targetStep = parseInt(this.dataset.step);
    if (targetStep < currentStep || this.classList.contains('completed')) {
      currentStep = targetStep;
      showStep(currentStep);
    }
  });
});
</script>
{% endblock %}


{% block guide_data %}
{
    "enabled": true,
    "page_name": "job_form",
    "title": "Post a Job Guide",
    "steps": [
        {
            "title": "Create Your Job Posting \ud83d\udcdd",
            "content": "<h3>Find the Perfect Worker</h3><p>Fill out this form to post your job listing and connect with qualified workers in your area.</p><div class='guide-tip'><strong>\ud83d\udca1 Tip:</strong> Clear, detailed job postings get better applicants!</div>"
        },
        {
            "title": "Job Details \ud83d\udccb",
            "content": "<h3>Essential Information</h3><p>Be specific about:</p><ul><li><strong>Title:</strong> Clear job name (e.g., 'Plumber Needed')</li><li><strong>Description:</strong> What work needs to be done</li><li><strong>Category:</strong> Type of work</li><li><strong>Budget:</strong> How much you'll pay</li></ul>"
        },
        {
            "title": "Requirements & Schedule \u23f0",
            "content": "<h3>Set Expectations</h3><p>Specify:</p><ul><li><strong>Required Skills:</strong> What workers must know</li><li><strong>Schedule:</strong> When work should be done</li><li><strong>Duration:</strong> How long the job will take</li><li><strong>Number of Workers:</strong> How many you need</li></ul>"
        },
        {
            "title": "Location & Tools \ud83d\udccd",
            "content": "<h3>Logistics Details</h3><p>Add information about:</p><ul><li><strong>Location:</strong> Where the work is</li><li><strong>Tools Provided:</strong> What you'll supply</li><li><strong>Materials:</strong> What's included</li></ul><div class='guide-warning'><strong>\u26a0\ufe0f Important:</strong> Accurate location helps workers plan their commute.</div>"
        },
        {
            "title": "Publish Your Job! \ud83d\ude80",
            "content": "<h3>Final Steps</h3><p>Before submitting:</p><ol><li>Review all information for accuracy</li><li>Make sure contact details are correct</li><li>Set a realistic budget</li><li>Click 'Post Job' to publish</li></ol><p>Your job will be visible to workers immediately! \ud83c\udf89</p>"
        }
    ]
}
{% endblock %}