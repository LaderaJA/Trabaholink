{% extends "mainpages/base.html" %}
{% load static %}
{% load i18n %}

{% block css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #f8f9fa;
  }

  .change-password-container {
    min-height: calc(100vh - 200px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
  }

  .password-card {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #e9ecef;
    max-width: 480px;
    width: 100%;
  }

  .password-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-top: 0.5rem;
    border-top: 1px solid #f3f4f6;
  }

  .password-header h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.5rem;
  }

  .password-header p {
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0;
  }

  .form-group {
    margin-bottom: 1.25rem;
  }

  .form-label {
    font-weight: 600;
    font-size: 0.875rem;
    color: #374151;
    margin-bottom: 0.5rem;
    display: block;
  }

  .input-wrapper {
    position: relative;
  }

  .form-control {
    padding: 0.625rem 2.5rem 0.625rem 0.875rem;
    border-radius: 8px;
    border: 1.5px solid #d1d5db;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    width: 100%;
  }

  .form-control:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
  }

  .form-control.is-invalid {
    border-color: #ef4444;
  }

  .toggle-password {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #6b7280;
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    transition: color 0.2s ease;
  }

  .toggle-password:hover {
    color: #3b82f6;
  }

  .password-strength {
    height: 3px;
    background-color: #e5e7eb;
    border-radius: 2px;
    margin-top: 0.5rem;
    overflow: hidden;
  }

  .strength-bar {
    height: 100%;
    width: 0%;
    background-color: #ef4444;
    transition: width 0.3s ease, background-color 0.3s ease;
  }

  .form-text {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.375rem;
    display: block;
  }

  .invalid-feedback {
    font-size: 0.75rem;
    color: #ef4444;
    margin-top: 0.375rem;
    display: block;
  }

  .btn-save {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    width: 100%;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 0.5rem;
  }

  .btn-save:hover {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }

  .btn-back {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #6b7280;
    font-size: 0.875rem;
    text-decoration: none;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    transition: all 0.2s ease;
    margin-bottom: 0;
    margin-left: 0;
  }

  .btn-back:hover {
    background: #f3f4f6;
    color: #3b82f6;
  }

  .btn-back i {
    font-size: 1rem;
  }

  .alert {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
  }

  .alert-danger {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #991b1b;
  }

  @media (max-width: 576px) {
    .password-card {
      padding: 1.5rem;
    }

    .password-header h2 {
      font-size: 1.25rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="change-password-container">
  <div class="password-card">
    <div style="margin-bottom: 2rem;">
      <a href="{% url 'profile' pk=user.pk %}" class="btn-back">
        <i class="bi bi-arrow-left"></i>
        <span>Back to Profile</span>
      </a>
    </div>

    <div class="password-header">
      <h2>Change Password</h2>
      <p>Enter your current password and choose a new one</p>
    </div>

    <form method="post">
      {% csrf_token %}
      
      {% if form.non_field_errors %}
        <div class="alert alert-danger" role="alert">
          {% for error in form.non_field_errors %}
            {{ error }}
          {% endfor %}
        </div>
      {% endif %}

      <div class="form-group">
        <label for="{{ form.old_password.id_for_label }}" class="form-label">
          Current Password <span class="text-danger">*</span>
        </label>
        <div class="input-wrapper">
          <input type="password" 
                 class="form-control {% if form.old_password.errors %}is-invalid{% endif %}" 
                 id="{{ form.old_password.id_for_label }}" 
                 name="{{ form.old_password.name }}" 
                 placeholder="Enter current password"
                 required>
          <button class="toggle-password" type="button" data-target="{{ form.old_password.id_for_label }}">
            <i class="bi bi-eye"></i>
          </button>
        </div>
        {% if form.old_password.errors %}
          <span class="invalid-feedback">
            {{ form.old_password.errors.0 }}
          </span>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="{{ form.new_password1.id_for_label }}" class="form-label">
          New Password <span class="text-danger">*</span>
        </label>
        <div class="input-wrapper">
          <input type="password" 
                 class="form-control {% if form.new_password1.errors %}is-invalid{% endif %}" 
                 id="{{ form.new_password1.id_for_label }}" 
                 name="{{ form.new_password1.name }}" 
                 placeholder="Enter new password"
                 required>
          <button class="toggle-password" type="button" data-target="{{ form.new_password1.id_for_label }}">
            <i class="bi bi-eye"></i>
          </button>
        </div>
        <div class="password-strength">
          <div class="strength-bar" id="passwordStrength"></div>
        </div>
        <span class="form-text" id="passwordHelp">
          Use 8+ characters with letters, numbers & symbols
        </span>
        {% if form.new_password1.errors %}
          <span class="invalid-feedback">
            {{ form.new_password1.errors.0 }}
          </span>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="{{ form.new_password2.id_for_label }}" class="form-label">
          Confirm New Password <span class="text-danger">*</span>
        </label>
        <div class="input-wrapper">
          <input type="password" 
                 class="form-control {% if form.new_password2.errors %}is-invalid{% endif %}" 
                 id="{{ form.new_password2.id_for_label }}" 
                 name="{{ form.new_password2.name }}" 
                 placeholder="Confirm new password"
                 required>
          <button class="toggle-password" type="button" data-target="{{ form.new_password2.id_for_label }}">
            <i class="bi bi-eye"></i>
          </button>
        </div>
        {% if form.new_password2.errors %}
          <span class="invalid-feedback">
            {{ form.new_password2.errors.0 }}
          </span>
        {% endif %}
      </div>

      <button type="submit" class="btn-save">
        <i class="bi bi-key me-2"></i>Change Password
      </button>
    </form>
  </div>
</div>
{% endblock %}

{% block js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Toggle password visibility
  document.querySelectorAll('.toggle-password').forEach(button => {
    button.addEventListener('click', function() {
      const targetId = this.getAttribute('data-target');
      const passwordInput = document.getElementById(targetId);
      const icon = this.querySelector('i');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
      } else {
        passwordInput.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
      }
    });
  });

  // Password strength meter
  const passwordInput = document.getElementById('{{ form.new_password1.id_for_label }}');
  const strengthBar = document.getElementById('passwordStrength');
  const passwordHelp = document.getElementById('passwordHelp');

  if (passwordInput && strengthBar) {
    passwordInput.addEventListener('input', function() {
      const password = this.value;
      let strength = 0;
      
      // Length check
      if (password.length >= 8) strength += 1;
      
      // Contains numbers
      if (/\d/.test(password)) strength += 1;
      
      // Contains lowercase and uppercase
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 1;
      
      // Contains special characters
      if (/[^A-Za-z0-9]/.test(password)) strength += 1;
      
      // Update strength bar
      const width = (strength / 4) * 100;
      strengthBar.style.width = width + '%';
      
      // Update color based on strength
      if (strength <= 1) {
        strengthBar.style.backgroundColor = '#dc3545';
        passwordHelp.textContent = 'Weak password';
      } else if (strength <= 2) {
        strengthBar.style.backgroundColor = '#fd7e14';
        passwordHelp.textContent = 'Moderate password';
      } else if (strength <= 3) {
        strengthBar.style.backgroundColor = '#ffc107';
        passwordHelp.textContent = 'Good password';
      } else {
        strengthBar.style.backgroundColor = '#198754';
        passwordHelp.textContent = 'Strong password';
      }
    });
  }

  // Enable Bootstrap tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});
</script>
{% endblock %}


{% block guide_data %}
{
    "enabled": true,
    "page_name": "change_password",
    "title": "Change Password Guide",
    "steps": [
        {
            "title": "Update Your Password \ud83d\udd10",
            "content": "<h3>Keep Your Account Secure</h3><p>Change your password regularly to maintain account security.</p>"
        },
        {
            "title": "Password Requirements \ud83d\udccb",
            "content": "<h3>Create a Strong Password</h3><ul><li>At least 8 characters</li><li>Mix of letters and numbers</li><li>Include special characters</li><li>Avoid common words</li><li>Don't reuse old passwords</li></ul>"
        }
    ]
}
{% endblock %}